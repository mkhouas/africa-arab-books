<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø±ØµØ¯ ÙƒØªØ¨ Ø§Ù„Ø´Ø£Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ ğŸŒ</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#f5f5f5;--card:#fff;--text:#1a1a1a;--text2:#666;
  --gold:#D4A017;--green:#009639;--black:#111;
  --ar:#009639;--fr:#2563eb;--en:#7c3aed;
  --shadow:0 2px 20px rgba(0,0,0,.08);--radius:16px
}
body{font-family:'Segoe UI','Cairo',Tahoma,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh}

/* Hero */
.hero{background:linear-gradient(135deg,#1B5E20 0%,#2E7D32 30%,#D4A017 70%,#E65100 100%);color:#fff;padding:48px 20px;text-align:center;position:relative}
.hero h1{font-size:2.4em;font-weight:900;margin-bottom:10px;text-shadow:2px 2px 8px rgba(0,0,0,.3)}
.hero .sub{font-size:1.15em;opacity:.95;margin-bottom:16px;font-weight:500}
.hero .info{font-size:.92em;opacity:.88;max-width:850px;margin:0 auto;line-height:1.8}

/* Stats */
.stats-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(125px,1fr));gap:10px;max-width:1400px;margin:-32px auto 24px;padding:0 20px;position:relative;z-index:10}
.stat-card{background:var(--card);border-radius:var(--radius);padding:18px 12px;text-align:center;box-shadow:var(--shadow);border-top:4px solid var(--green);transition:transform .3s}
.stat-card:hover{transform:translateY(-3px)}
.stat-card .icon{font-size:1.6em;margin-bottom:4px}
.stat-card .num{font-size:1.7em;font-weight:900;color:var(--green);line-height:1}
.stat-card .lbl{font-size:.78em;color:var(--text2);margin-top:4px;font-weight:600}

/* Controls */
.controls{max-width:1400px;margin:0 auto 24px;padding:0 20px}
.search-row{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap}
.search-box{flex:1;min-width:260px;padding:12px 22px;border-radius:50px;border:2px solid #e0e0e0;font-size:1em;outline:none;transition:all .3s;background:#fff}
.search-box:focus{border-color:var(--green);box-shadow:0 0 0 4px rgba(0,150,57,.1)}
.filter-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.filter-label{font-size:.88em;font-weight:700;color:var(--text);margin-left:4px}
.fbtn{padding:8px 18px;border-radius:50px;border:2px solid #e0e0e0;background:#fff;cursor:pointer;font-size:.88em;font-weight:700;transition:all .3s;color:var(--text)}
.fbtn:hover{border-color:var(--green);color:var(--green)}
.fbtn.active{background:var(--green);color:#fff;border-color:var(--green)}
.fbtn.a-ar{background:var(--ar);color:#fff;border-color:var(--ar)}
.fbtn.a-fr{background:var(--fr);color:#fff;border-color:var(--fr)}
.fbtn.a-en{background:var(--en);color:#fff;border-color:var(--en)}
.sel{padding:8px 16px;border-radius:50px;border:2px solid #e0e0e0;background:#fff;font-size:.88em;font-weight:600;cursor:pointer;outline:none}
.sel:focus{border-color:var(--green)}

/* Update bar */
.update-bar{max-width:1400px;margin:0 auto 16px;padding:0 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.live{display:flex;align-items:center;gap:8px;font-size:.88em;color:var(--green);font-weight:700}
.live-dot{width:9px;height:9px;background:var(--green);border-radius:50%;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.8)}}
.time{font-size:.82em;color:var(--text2)}
.rbtn{padding:9px 22px;border-radius:50px;border:none;background:var(--green);color:#fff;cursor:pointer;font-size:.88em;font-weight:700;transition:all .3s;box-shadow:0 2px 8px rgba(0,150,57,.2)}
.rbtn:hover{background:#007a2e}
.rbtn:disabled{opacity:.5;cursor:not-allowed}

/* Sources display */
.src-stats{max-width:1400px;margin:0 auto 14px;padding:0 20px}
.src-grid{display:flex;flex-wrap:wrap;gap:6px}
.src-tag{padding:5px 12px;border-radius:30px;font-size:.75em;font-weight:700;background:#f0f9f4;color:var(--green);border:1px solid #d1f0dd;display:flex;align-items:center;gap:4px}
.src-tag .dot{width:7px;height:7px;border-radius:50%}
.src-tag .dot.on{background:var(--green)}.src-tag .dot.off{background:#ccc}

/* Progress */
.pbar{max-width:1400px;margin:0 auto 14px;padding:0 20px;display:none}
.ptrack{height:5px;background:#e0e0e0;border-radius:5px;overflow:hidden}
.pfill{height:100%;background:linear-gradient(90deg,var(--green),var(--gold));border-radius:5px;transition:width .4s;width:0}
.ptxt{font-size:.78em;color:var(--text2);margin-top:5px;text-align:center;font-weight:600}

/* Error log */
.elog{max-width:1400px;margin:0 auto 14px;padding:0 20px;display:none}
.elog-box{background:#fff3e0;border:1px solid #ffe0b2;border-radius:12px;padding:12px 16px;font-size:.82em;color:#E65100;max-height:120px;overflow-y:auto}

/* Books grid */
.books-grid{max-width:1400px;margin:0 auto;padding:0 20px 50px;display:grid;grid-template-columns:repeat(auto-fill,minmax(330px,1fr));gap:22px}
.book-card{background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);border-top:4px solid var(--green);transition:transform .3s,box-shadow .3s;display:flex;flex-direction:column}
.book-card:hover{transform:translateY(-5px);box-shadow:0 10px 36px rgba(0,0,0,.14)}
.cover-wrap{position:relative;height:230px;background:linear-gradient(135deg,#1a1a1a,#333);display:flex;align-items:center;justify-content:center;overflow:hidden}
.cover-wrap img{height:190px;max-width:140px;object-fit:cover;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.5);transition:transform .4s;position:relative;z-index:2}
.book-card:hover .cover-wrap img{transform:scale(1.05)}
.no-cover{width:130px;height:180px;background:linear-gradient(135deg,#1B5E20,#D4A017);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:3.5em;position:relative;z-index:2}
.lang-badge{position:absolute;top:12px;right:12px;padding:5px 14px;border-radius:30px;font-size:.78em;font-weight:800;color:#fff;z-index:3;box-shadow:0 2px 8px rgba(0,0,0,.3)}
.l-ar{background:var(--ar)}.l-fr{background:var(--fr)}.l-en{background:var(--en)}
.src-badge{position:absolute;bottom:10px;left:10px;padding:4px 10px;border-radius:10px;font-size:.68em;background:rgba(255,255,255,.2);color:rgba(255,255,255,.9);backdrop-filter:blur(6px);font-weight:700;z-index:3}
.book-body{padding:18px;flex:1;display:flex;flex-direction:column}
.book-title{font-size:1.05em;font-weight:800;line-height:1.5;color:var(--text);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;margin-bottom:8px}
.book-author{font-size:.92em;color:var(--green);font-weight:700;margin-bottom:5px}
.book-pub{font-size:.82em;color:var(--text2);margin-bottom:8px}
.book-meta{display:flex;flex-wrap:wrap;gap:10px;font-size:.78em;color:var(--text2);margin-bottom:10px}
.book-meta span{display:flex;align-items:center;gap:4px;font-weight:600}
.topics{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:12px}
.tag{padding:3px 12px;border-radius:30px;font-size:.72em;background:#f0f9f4;color:var(--green);font-weight:700;border:1px solid #d1f0dd}
.tag.hot{background:#fff3e0;color:#E65100;border-color:#ffe0b2}
.book-desc{font-size:.85em;color:var(--text2);line-height:1.6;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;margin-bottom:12px}
.book-actions{margin-top:auto;display:flex;gap:8px;flex-wrap:wrap}
.blink{flex:1;min-width:90px;padding:10px;text-align:center;border-radius:12px;font-size:.83em;font-weight:700;text-decoration:none;transition:all .3s}
.bp{background:var(--black);color:#fff}.bp:hover{background:var(--green);transform:translateY(-2px)}
.bs{background:#f5f5f5;color:var(--text);border:2px solid #e0e0e0}.bs:hover{background:#eee;border-color:var(--green)}
.loader{text-align:center;padding:70px;grid-column:1/-1}
.spinner{width:50px;height:50px;border:4px solid #e0e0e0;border-top-color:var(--green);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.loader p{font-size:1em;color:var(--text2);font-weight:600}
.no-res{text-align:center;padding:70px;grid-column:1/-1;color:var(--text2)}
.no-res .emoji{font-size:4em;margin-bottom:14px}
.notif{position:fixed;bottom:20px;right:20px;background:var(--green);color:#fff;padding:14px 22px;border-radius:12px;font-weight:700;font-size:.92em;box-shadow:0 6px 28px rgba(0,0,0,.3);z-index:1000;display:none;animation:slideUp .5s ease-out}
@keyframes slideUp{from{transform:translateY(80px);opacity:0}to{transform:translateY(0);opacity:1}}
footer{background:linear-gradient(135deg,#1B5E20,#2c2c2c);color:#fff;text-align:center;padding:36px 20px;margin-top:36px}
footer h3{font-size:1.3em;margin-bottom:10px;font-weight:800}
footer p{font-size:.88em;opacity:.85;margin-bottom:5px;line-height:1.7}
@media(max-width:768px){
  .hero h1{font-size:1.6em}
  .books-grid{grid-template-columns:1fr}
  .stats-bar{grid-template-columns:repeat(3,1fr)}
  .filter-row{justify-content:center}
}
</style>
</head>
<body>

<div class="hero">
  <h1>ğŸŒ Ù…Ø±ØµØ¯ ÙƒØªØ¨ Ø§Ù„Ø´Ø£Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ</h1>
  <p class="sub">Africa Books Observatory | Observatoire des livres africains</p>
  <p class="info">
    ÙŠØ¬Ù…Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø§Ù„ÙƒØªØ¨ Ø§Ù„ØµØ§Ø¯Ø±Ø© Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± 12 Ø´Ù‡Ø±Ø§Ù‹ Ø­ÙˆÙ„ Ø§Ù„Ø´Ø£Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ
    <br>Ù…Ù† Ù…ØµØ§Ø¯Ø± Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ÙˆØ±Ù‚Ù…ÙŠØ© Ù…ØªØ¹Ø¯Ø¯Ø© â€” Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ§Ù„ÙØ±Ù†Ø³ÙŠØ©
  </p>
</div>

<div class="stats-bar">
  <div class="stat-card"><div class="icon">ğŸ“š</div><div class="num" id="sTotal">0</div><div class="lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div></div>
  <div class="stat-card"><div class="icon">ğŸŸ¢</div><div class="num" id="sAr">0</div><div class="lbl">Ø¹Ø±Ø¨ÙŠ</div></div>
  <div class="stat-card"><div class="icon">ğŸŸ£</div><div class="num" id="sEn">0</div><div class="lbl">English</div></div>
  <div class="stat-card"><div class="icon">ğŸ”µ</div><div class="num" id="sFr">0</div><div class="lbl">FranÃ§ais</div></div>
  <div class="stat-card"><div class="icon">ğŸ›</div><div class="num" id="sPub">0</div><div class="lbl">Ù†Ø§Ø´Ø±</div></div>
  <div class="stat-card"><div class="icon">ğŸ”Œ</div><div class="num" id="sSrc">0</div><div class="lbl">Ù…ØµØ¯Ø±</div></div>
</div>

<div class="controls">
  <div class="search-row">
    <input type="text" class="search-box" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒØªØ§Ø¨ Ø£Ùˆ Ù…Ø¤Ù„Ù Ø£Ùˆ Ù†Ø§Ø´Ø±..." oninput="filterBooks()">
  </div>
  <div class="filter-row">
    <span class="filter-label">Ø§Ù„Ù„ØºØ©:</span>
    <button class="fbtn active" onclick="setLang('all',this)">Ø§Ù„ÙƒÙ„</button>
    <button class="fbtn" onclick="setLang('ar',this)">Ø¹Ø±Ø¨ÙŠ</button>
    <button class="fbtn" onclick="setLang('en',this)">English</button>
    <button class="fbtn" onclick="setLang('fr',this)">FranÃ§ais</button>

    <span class="filter-label" style="margin-right:14px">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:</span>
    <select class="sel" id="topicSel" onchange="filterBooks()">
      <option value="">Ø§Ù„ÙƒÙ„</option>
      <option value="Politics">Ø§Ù„Ø³ÙŠØ§Ø³Ø©</option>
      <option value="History">Ø§Ù„ØªØ§Ø±ÙŠØ®</option>
      <option value="Economy">Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯</option>
      <option value="Development">Ø§Ù„ØªÙ†Ù…ÙŠØ©</option>
      <option value="Conflict">Ø§Ù„Ù†Ø²Ø§Ø¹Ø§Øª</option>
      <option value="Sahel">Ø§Ù„Ø³Ø§Ø­Ù„</option>
      <option value="Horn">Ø§Ù„Ù‚Ø±Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ</option>
      <option value="North Africa">Ø´Ù…Ø§Ù„ Ø£ÙØ±ÙŠÙ‚ÙŠØ§</option>
      <option value="West Africa">ØºØ±Ø¨ Ø£ÙØ±ÙŠÙ‚ÙŠØ§</option>
      <option value="East Africa">Ø´Ø±Ù‚ Ø£ÙØ±ÙŠÙ‚ÙŠØ§</option>
      <option value="Southern">Ø§Ù„Ø¬Ù†ÙˆØ¨ Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ</option>
      <option value="Central">ÙˆØ³Ø· Ø£ÙØ±ÙŠÙ‚ÙŠØ§</option>
      <option value="Migration">Ø§Ù„Ù‡Ø¬Ø±Ø©</option>
      <option value="Security">Ø§Ù„Ø£Ù…Ù†</option>
      <option value="Culture">Ø§Ù„Ø«Ù‚Ø§ÙØ©</option>
      <option value="Literature">Ø§Ù„Ø£Ø¯Ø¨</option>
      <option value="Governance">Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</option>
      <option value="Terrorism">Ø§Ù„Ø¥Ø±Ù‡Ø§Ø¨</option>
      <option value="Education">Ø§Ù„ØªØ¹Ù„ÙŠÙ…</option>
    </select>

    <span class="filter-label" style="margin-right:14px">Ø§Ù„Ù…ØµØ¯Ø±:</span>
    <select class="sel" id="srcSel" onchange="filterBooks()">
      <option value="">Ø§Ù„ÙƒÙ„</option>
    </select>

    <span class="filter-label" style="margin-right:14px">ØªØ±ØªÙŠØ¨:</span>
    <select class="sel" id="sortSel" onchange="filterBooks()">
      <option value="newest">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
      <option value="oldest">Ø§Ù„Ø£Ù‚Ø¯Ù…</option>
      <option value="title">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</option>
    </select>
  </div>
</div>

<div class="update-bar">
  <div class="live"><span class="live-dot"></span><span>Ù…Ø³Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠ</span></div>
  <span class="time" id="lastUp">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
  <button class="rbtn" id="rBtn" onclick="manualRefresh()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
</div>

<div class="src-stats" id="srcStats"></div>

<div class="pbar" id="pbar">
  <div class="ptrack"><div class="pfill" id="pfill"></div></div>
  <div class="ptxt" id="ptxt"></div>
</div>

<div class="elog" id="elog">
  <div class="elog-box" id="elogBox"></div>
</div>

<div class="books-grid" id="grid">
  <div class="loader"><div class="spinner"></div><p>Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
</div>

<div class="notif" id="notif"></div>

<footer>
  <h3>ğŸŒ Ù…Ø±ØµØ¯ ÙƒØªØ¨ Ø§Ù„Ø´Ø£Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ</h3>
  <p>Ø¬Ù…Ø¹ Ø¢Ù„ÙŠ Ù…Ù† Ù…ØµØ§Ø¯Ø± Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ÙˆØ±Ù‚Ù…ÙŠØ© Ù…ØªØ¹Ø¯Ø¯Ø©</p>
  <p style="font-size:.8em;margin-top:8px">2025 Â© Africa Books Observatory</p>
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Africa Books Observatory v3
//  Tested & Fixed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let ALL_BOOKS = [];
let currentLang = 'all';
let isUpdating = false;
let activeSources = new Map();
let errorLog = [];
const CACHE_KEY = 'afbooks_v3';
const DAY_MS = 24*60*60*1000;

// â”€â”€ Utilities â”€â”€
function getMinDate() {
  const d = new Date();
  d.setMonth(d.getMonth() - 12);
  return d;
}

function getMinDateISO() {
  const d = getMinDate();
  return d.toISOString().split('T')[0];
}

function isRecent(dateStr) {
  if (!dateStr) return false;
  try {
    // Handle year-only
    if (/^\d{4}$/.test(dateStr)) dateStr += '-01-01';
    const d = new Date(dateStr);
    return !isNaN(d.getTime()) && d >= getMinDate();
  } catch(e) { return false; }
}

function fmtDate(ds) {
  if (!ds) return '';
  try {
    if (/^\d{4}$/.test(ds)) ds += '-01-01';
    const d = new Date(ds);
    if (isNaN(d.getTime())) return '';
    const m = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return m[d.getMonth()] + ' ' + d.getFullYear();
  } catch(e) { return ''; }
}

function fmtNow() {
  const d = new Date();
  const m = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return d.getDate()+' '+m[d.getMonth()]+' '+d.getFullYear()+' '+
    String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
function esc(s) { const d = document.createElement('div'); d.textContent = s||''; return d.innerHTML; }

function showNotif(msg) {
  const el = document.getElementById('notif');
  el.textContent = msg; el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 5000);
}

function logError(src, msg) {
  errorLog.push({ src, msg, time: new Date().toLocaleTimeString() });
  const el = document.getElementById('elog');
  const box = document.getElementById('elogBox');
  el.style.display = 'block';
  box.innerHTML = errorLog.slice(-10).map(e =>
    '<div>âš ï¸ ['+e.time+'] '+e.src+': '+e.msg+'</div>'
  ).join('');
}

// Fetch with timeout
async function fetchWithTimeout(url, options = {}, timeoutMs = 12000) {
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), timeoutMs);
  try {
    const resp = await fetch(url, { ...options, signal: controller.signal });
    clearTimeout(timer);
    return resp;
  } catch(e) {
    clearTimeout(timer);
    throw e;
  }
}

// â”€â”€ Africa Keywords â”€â”€
const AFK = [
  'africa','african','sub-saharan','subsaharan',
  'west africa','east africa','north africa','southern africa','central africa',
  'sahel','maghreb','african union','pan-african',
  'nigeria','nigerian','ethiopia','ethiopian','kenya','kenyan',
  'south africa','ghana','ghanaian','tanzania','tanzanian',
  'uganda','ugandan','senegal','senegalese','cameroon','cameroonian',
  'ivory coast','mozambique','madagascar','angola','angolan',
  'mali','malian','niger','nigerien','burkina faso','chad','chadian',
  'sudan','sudanese','south sudan','somalia','somali','somaliland',
  'eritrea','djibouti','rwanda','rwandan','burundi','congo','congolese','drc',
  'zimbabwe','zambia','malawi','botswana','namibia','lesotho','eswatini',
  'morocco','moroccan','algeria','algerian','tunisia','tunisian',
  'libya','libyan','egypt','egyptian','mauritania',
  'sierra leone','liberia','guinea','gambia','togo','benin','gabon',
  'horn of africa','lake chad','western sahara',
  'ecowas','sadc','igad','comesa','nepad','afdb','afcfta',
  'boko haram','al-shabaab','african diaspora',

  'afrique','africain','africaine','afrique subsaharienne',
  'union africaine','panafricain','cedeao',
  'sahel','migration africaine','gouvernance africaine',

  'Ø£ÙØ±ÙŠÙ‚ÙŠØ§','Ø£ÙØ±ÙŠÙ‚ÙŠ','Ø£ÙØ±ÙŠÙ‚ÙŠØ©','Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ','Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©',
  'Ø§ÙØ±ÙŠÙ‚ÙŠØ§','Ø§ÙØ±ÙŠÙ‚ÙŠ','Ø§Ù„Ø§ÙØ±ÙŠÙ‚ÙŠ','Ø§Ù„Ø§ÙØ±ÙŠÙ‚ÙŠØ©',
  'ØºØ±Ø¨ Ø£ÙØ±ÙŠÙ‚ÙŠØ§','Ø´Ø±Ù‚ Ø£ÙØ±ÙŠÙ‚ÙŠØ§','Ø´Ù…Ø§Ù„ Ø£ÙØ±ÙŠÙ‚ÙŠØ§',
  'Ø¬Ù†ÙˆØ¨ Ø£ÙØ±ÙŠÙ‚ÙŠØ§','ÙˆØ³Ø· Ø£ÙØ±ÙŠÙ‚ÙŠØ§',
  'Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ','Ø§Ù„Ù‚Ø§Ø±Ø© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©','Ø§Ù„Ù‚Ø§Ø±Ø© Ø§Ù„Ø³Ù…Ø±Ø§Ø¡',
  'Ø§Ù„Ø³Ø§Ø­Ù„','Ø§Ù„Ù‚Ø±Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ','Ø§Ù„Ù…ØºØ±Ø¨ Ø§Ù„Ø¹Ø±Ø¨ÙŠ',
  'Ù†ÙŠØ¬ÙŠØ±ÙŠØ§','Ø¥Ø«ÙŠÙˆØ¨ÙŠØ§','ÙƒÙŠÙ†ÙŠØ§','ØºØ§Ù†Ø§','Ø§Ù„Ø³Ù†ØºØ§Ù„','Ø§Ù„ÙƒØ§Ù…ÙŠØ±ÙˆÙ†',
  'Ø§Ù„ÙƒÙˆÙ†ØºÙˆ','Ø§Ù„Ø³ÙˆØ¯Ø§Ù†','Ø§Ù„ØµÙˆÙ…Ø§Ù„','Ù…Ø§Ù„ÙŠ','Ø§Ù„Ù†ÙŠØ¬Ø±','ØªØ´Ø§Ø¯',
  'Ø§Ù„Ù…ØºØ±Ø¨','Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±','ØªÙˆÙ†Ø³','Ù„ÙŠØ¨ÙŠØ§','Ù…ÙˆØ±ÙŠØªØ§Ù†ÙŠØ§',
  'Ø¨ÙˆÙƒÙˆ Ø­Ø±Ø§Ù…','Ø¥ÙŠÙƒÙˆØ§Ø³','Ù…Ø§Ù†Ø¯ÙŠÙ„Ø§'
];

function isAfricaBook(title, desc, authors) {
  const t = (title || '').toLowerCase();
  const d = (desc || '').toLowerCase();

  // Title match = strong
  for (const kw of AFK) {
    if (t.includes(kw)) return true;
  }

  // Description: 2+ matches
  let hits = 0;
  for (const kw of AFK) {
    if (d.includes(kw)) { hits++; if (hits >= 2) return true; }
  }

  return false;
}

function detectLang(text) {
  if (!text) return 'en';
  if (/[\u0600-\u06FF]/.test(text)) return 'ar';
  if (/[Ã Ã¢Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã¿Ã§Å“Ã¦]/i.test(text)) return 'fr';
  if (/\b(le|la|les|du|des|une?|et|dans|pour|avec|sur|par|livre|afrique|politique)\b/i.test(text)) return 'fr';
  return 'en';
}

function detectTopics(title, desc) {
  const t = ((title||'')+' '+(desc||'')).toLowerCase();
  const out = [];
  const map = [
    [/politi|Ø³ÙŠØ§Ø³/i,'Politics'],[/histor|histoire|ØªØ§Ø±ÙŠØ®/i,'History'],
    [/econom|Ã©conomi|Ø§Ù‚ØªØµØ§Ø¯/i,'Economy'],[/develop|dÃ©velopp|ØªÙ†Ù…ÙŠ/i,'Development'],
    [/conflict|conflit|guerre|war|Ø­Ø±Ø¨|Ù†Ø²Ø§Ø¹/i,'Conflict'],
    [/sahel|Ø³Ø§Ø­Ù„/i,'Sahel'],[/horn.of.africa|corne|Ù‚Ø±Ù†/i,'Horn of Africa'],
    [/north.africa|afrique.du.nord|Ø´Ù…Ø§Ù„/i,'North Africa'],
    [/west.africa|afrique.de.l.ouest|ØºØ±Ø¨/i,'West Africa'],
    [/east.africa|afrique.de.l.est|Ø´Ø±Ù‚/i,'East Africa'],
    [/southern.africa|afrique.australe|Ø¬Ù†ÙˆØ¨/i,'Southern Africa'],
    [/central.africa|afrique.centrale|ÙˆØ³Ø·/i,'Central Africa'],
    [/migrat|Ù‡Ø¬Ø±/i,'Migration'],[/secur|sÃ©cur|Ø£Ù…Ù†/i,'Security'],
    [/cultur|Ø«Ù‚Ø§Ù/i,'Culture'],[/liter|littÃ©r|Ø£Ø¯Ø¨/i,'Literature'],
    [/health|santÃ©|ØµØ­/i,'Health'],[/environment|Ø¨ÙŠØ¦/i,'Environment'],
    [/governance|gouvernance|Ø­ÙˆÙƒÙ…/i,'Governance'],
    [/terror|Ø¥Ø±Ù‡Ø§Ø¨/i,'Terrorism'],[/democra|Ø¯ÙŠÙ…Ù‚Ø±Ø§Ø·/i,'Democracy'],
    [/colon|Ø§Ø³ØªØ¹Ù…Ø§Ø±/i,'Colonialism'],[/trade|commerce|ØªØ¬Ø§Ø±/i,'Trade'],
    [/education|Ã©ducation|ØªØ¹Ù„ÙŠÙ…/i,'Education'],[/agricul|Ø²Ø±Ø§Ø¹/i,'Agriculture'],
    [/women|femmes|Ù…Ø±Ø£Ø©/i,'Women'],[/youth|jeunesse|Ø´Ø¨Ø§Ø¨/i,'Youth'],
    [/refugee|rÃ©fugiÃ©|Ù„Ø§Ø¬Ø¦/i,'Refugees']
  ];
  for (const [rx, label] of map) if (rx.test(t)) out.push(label);
  return out.length ? out.slice(0,5) : ['Africa'];
}

// â”€â”€ Deduplication â”€â”€
function normT(s) {
  return (s||'').toLowerCase().replace(/[^\w\s\u0600-\u06FF]/g,' ').replace(/\s+/g,' ').trim().substring(0,80);
}

function dedup(books) {
  const seen = new Set(), titles = [], out = [];
  for (const b of books) {
    const nt = normT(b.title);
    if (!nt || nt.length < 4) continue;
    const isbn = (b.isbn||'').replace(/[^0-9X]/gi,'');
    if (isbn.length >= 10) {
      if (seen.has('i:'+isbn)) continue;
      seen.add('i:'+isbn);
    }
    let dup = false;
    for (const et of titles) {
      if (nt === et || (nt.length > 10 && et.length > 10 && (nt.includes(et) || et.includes(nt)))) { dup = true; break; }
    }
    if (dup) continue;
    titles.push(nt);
    out.push(b);
  }
  return out;
}

// â”€â”€ Make Book Object â”€â”€
function mkBook(id, title, authors, publisher, pubDate, pages, isbn, url, cover, desc, lang, source) {
  return {
    id, title: (title||'').trim(),
    authors: (authors||[]).filter(Boolean).map(a => a.trim()),
    publisher: (publisher||'').trim(),
    publication_date: pubDate || '',
    pages: pages || null,
    isbn: isbn || '',
    book_url: url || '',
    cover: (cover||'').replace('http:', 'https:'),
    description: (desc||'').substring(0, 500).trim(),
    language: lang || 'en',
    topics: detectTopics(title, desc),
    source,
    rating: null,
    addedAt: Date.now()
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUERIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Q = {
  en: [
    "africa","african politics","african history","african economy",
    "african development","sub-saharan africa","west africa",
    "east africa","north africa","southern africa","central africa",
    "sahel crisis","horn of africa","african union","pan-africanism",
    "african governance","african democracy","african conflict",
    "african migration","african diaspora","african literature",
    "nigeria","ethiopia","kenya","south africa","ghana",
    "senegal","congo","sudan crisis","somalia","cameroon",
    "mali","niger","burkina faso","chad","boko haram",
    "ECOWAS","SADC","AfCFTA","african climate change",
    "decolonization africa","postcolonial africa","apartheid",
    "african refugees","african women rights","african youth",
    "rwanda","darfur","tigray conflict","libyan crisis"
  ],
  fr: [
    "afrique","politique africaine","histoire africaine",
    "Ã©conomie africaine","dÃ©veloppement africain",
    "afrique subsaharienne","afrique de l'ouest","afrique de l'est",
    "afrique du nord","afrique australe","afrique centrale",
    "sahel crise","corne afrique","union africaine","panafricanisme",
    "gouvernance africaine","dÃ©mocratie africaine","conflit africain",
    "migration africaine","diaspora africaine","littÃ©rature africaine",
    "sÃ©nÃ©gal","cameroun","congo","mali","niger","burkina faso",
    "tchad","boko haram","CEDEAO","franc CFA",
    "dÃ©colonisation afrique","femmes africaines","jeunesse africaine",
    "achille mbembe","felwine sarr","alain mabanckou"
  ],
  ar: [
    "Ø£ÙØ±ÙŠÙ‚ÙŠØ§","Ø§Ù„Ø´Ø£Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ","Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©",
    "Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ","Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ","Ø§Ù„ØªÙ†Ù…ÙŠØ© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©",
    "ØºØ±Ø¨ Ø£ÙØ±ÙŠÙ‚ÙŠØ§","Ø´Ø±Ù‚ Ø£ÙØ±ÙŠÙ‚ÙŠØ§","Ø´Ù…Ø§Ù„ Ø£ÙØ±ÙŠÙ‚ÙŠØ§","Ø¬Ù†ÙˆØ¨ Ø£ÙØ±ÙŠÙ‚ÙŠØ§",
    "ÙˆØ³Ø· Ø£ÙØ±ÙŠÙ‚ÙŠØ§","Ø§Ù„Ø³Ø§Ø­Ù„ Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ","Ø§Ù„Ù‚Ø±Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ",
    "Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ","Ø§Ù„Ù†Ø²Ø§Ø¹Ø§Øª Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©","Ø§Ù„Ù‡Ø¬Ø±Ø© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©",
    "Ø§Ù„Ø£Ø¯Ø¨ Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ","Ù†ÙŠØ¬ÙŠØ±ÙŠØ§","Ø¥Ø«ÙŠÙˆØ¨ÙŠØ§","ÙƒÙŠÙ†ÙŠØ§",
    "Ø§Ù„Ø³ÙˆØ¯Ø§Ù†","Ø§Ù„ØµÙˆÙ…Ø§Ù„","Ù…Ø§Ù„ÙŠ","Ø§Ù„ÙƒÙˆÙ†ØºÙˆ","Ø§Ù„Ù…ØºØ±Ø¨","Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±",
    "ØªÙˆÙ†Ø³","Ù„ÙŠØ¨ÙŠØ§","Ø¨ÙˆÙƒÙˆ Ø­Ø±Ø§Ù…","Ø¥ÙŠÙƒÙˆØ§Ø³","Ù…Ø§Ù†Ø¯ÙŠÙ„Ø§"
  ]
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOURCE 1: Google Books API âœ…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcGoogleBooks(query, langR) {
  const books = [];
  try {
    const p = new URLSearchParams({
      q: query, printType: 'books', orderBy: 'newest', maxResults: '40'
    });
    if (langR === 'ar' || langR === 'fr') p.set('langRestrict', langR);

    const resp = await fetchWithTimeout('https://www.googleapis.com/books/v1/volumes?' + p);
    if (resp.status === 429) { logError('Google Books', 'Rate limited'); return books; }
    if (!resp.ok) return books;

    const data = await resp.json();
    for (const item of (data.items || [])) {
      try {
        const v = item.volumeInfo || {};
        if (!v.title) continue;
        const pd = v.publishedDate || '';
        if (!pd || !isRecent(pd)) continue;
        const fullTitle = v.title + (v.subtitle ? ': ' + v.subtitle : '');
        if (!isAfricaBook(fullTitle, v.description, v.authors)) continue;
        const lang = v.language === 'ar' ? 'ar' : v.language === 'fr' ? 'fr' : detectLang(v.title);
        const isbns = v.industryIdentifiers || [];
        const isbnVal = (isbns.find(i => i.type === 'ISBN_13') || isbns[0] || {}).identifier || '';
        books.push(mkBook(
          item.id, fullTitle, v.authors, v.publisher, pd, v.pageCount,
          isbnVal, v.infoLink, (v.imageLinks||{}).thumbnail,
          v.description, lang, 'Google Books'
        ));
      } catch(e) {}
    }
  } catch(e) { logError('Google Books', e.message); }
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOURCE 2: Open Library API âœ…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcOpenLibrary(query) {
  const books = [];
  try {
    const resp = await fetchWithTimeout(
      'https://openlibrary.org/search.json?q=' + encodeURIComponent(query) + '&limit=25&sort=new'
    );
    if (!resp.ok) return books;
    const data = await resp.json();
    for (const doc of (data.docs || [])) {
      try {
        if (!doc.title) continue;
        const yr = doc.first_publish_year;
        if (!yr) continue;
        const pd = yr + '-01-01';
        if (!isRecent(pd)) continue;
        const subj = (doc.subject || []).join(' ');
        if (!isAfricaBook(doc.title, subj, doc.author_name)) continue;
        const cid = doc.cover_i;
        books.push(mkBook(
          'ol_' + doc.key, doc.title, doc.author_name,
          (doc.publisher||[])[0], pd, doc.number_of_pages_median,
          (doc.isbn||[])[0], 'https://openlibrary.org' + doc.key,
          cid ? 'https://covers.openlibrary.org/b/id/' + cid + '-M.jpg' : '',
          '', detectLang(doc.title), 'Open Library'
        ));
      } catch(e) {}
    }
  } catch(e) { logError('Open Library', e.message); }
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOURCE 3: Crossref API âœ…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcCrossref(query) {
  const books = [];
  try {
    const p = new URLSearchParams({
      query,
      filter: 'type:book,from-pub-date:' + getMinDateISO(),
      rows: '20', sort: 'published', order: 'desc'
    });
    const resp = await fetchWithTimeout(
      'https://api.crossref.org/works?' + p,
      { headers: { 'User-Agent': 'AfricaBooks/1.0 (mailto:test@example.com)' } }
    );
    if (!resp.ok) return books;
    const data = await resp.json();
    for (const item of ((data.message || {}).items || [])) {
      try {
        const title = (item.title || [])[0];
        if (!title) continue;
        const auths = (item.author || []).map(a => ((a.given||'') + ' ' + (a.family||'')).trim());
        if (!isAfricaBook(title, (item.subject||[]).join(' '), auths)) continue;
        const dp = ((item['published-print'] || item['published-online'] || {})['date-parts'] || [])[0];
        if (!dp) continue;
        const pd = dp[0] + '-' + String(dp[1]||1).padStart(2,'0') + '-' + String(dp[2]||1).padStart(2,'0');
        if (!isRecent(pd)) continue;
        books.push(mkBook(
          'cr_' + (item.DOI || Math.random().toString(36).substr(2,8)),
          title, auths, item.publisher, pd, null,
          (item.ISBN || [])[0],
          item.URL || (item.DOI ? 'https://doi.org/' + item.DOI : ''),
          '', '', detectLang(title), 'Crossref'
        ));
      } catch(e) {}
    }
  } catch(e) { logError('Crossref', e.message); }
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOURCE 4: OpenAlex API âœ…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcOpenAlex(query) {
  const books = [];
  try {
    const p = new URLSearchParams({
      search: query,
      filter: 'type:book,from_publication_date:' + getMinDateISO(),
      per_page: '25',
      sort: 'publication_date:desc'
    });
    const resp = await fetchWithTimeout(
      'https://api.openalex.org/works?' + p,
      { headers: { 'User-Agent': 'mailto:test@example.com' } }
    );
    if (!resp.ok) return books;
    const data = await resp.json();
    for (const w of (data.results || [])) {
      try {
        const title = w.title || w.display_name;
        if (!title) continue;
        const pd = w.publication_date;
        if (!pd || !isRecent(pd)) continue;
        const auths = (w.authorships || []).map(a => (a.author || {}).display_name || '').filter(Boolean);
        const concepts = (w.concepts || []).map(c => c.display_name || '').join(' ');
        if (!isAfricaBook(title, concepts, auths)) continue;
        const doi = w.doi ? w.doi.replace('https://doi.org/', '') : '';
        const url = doi ? 'https://doi.org/' + doi :
          ((w.primary_location || {}).landing_page_url || w.id || '');
        books.push(mkBook(
          'oa_' + (w.id || Math.random().toString(36).substr(2,8)),
          title, auths,
          ((w.primary_location || {}).source || {}).display_name || '',
          pd, null, '', url, '', '', detectLang(title), 'OpenAlex'
        ));
      } catch(e) {}
    }
  } catch(e) { logError('OpenAlex', e.message); }
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOURCE 5: Semantic Scholar API âœ…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcSemanticScholar(query) {
  const books = [];
  try {
    const yr = new Date().getFullYear();
    const p = new URLSearchParams({
      query, limit: '15',
      fields: 'title,authors,year,externalIds,url,publicationDate,venue,abstract',
      year: (yr-1) + '-' + yr
    });
    const resp = await fetchWithTimeout(
      'https://api.semanticscholar.org/graph/v1/paper/search?' + p, {}, 15000
    );
    if (resp.status === 429) {
      logError('Semantic Scholar', 'Rate limited');
      return books;
    }
    if (!resp.ok) return books;
    const data = await resp.json();
    for (const paper of (data.data || [])) {
      try {
        if (!paper.title) continue;
        const pd = paper.publicationDate || (paper.year ? paper.year + '-01-01' : '');
        if (!pd || !isRecent(pd)) continue;
        const auths = (paper.authors || []).map(a => a.name || '');
        if (!isAfricaBook(paper.title, (paper.abstract||'') + ' ' + (paper.venue||''), auths)) continue;
        const doi = (paper.externalIds || {}).DOI;
        books.push(mkBook(
          'ss_' + paper.paperId, paper.title, auths, paper.venue || '',
          pd, null, '',
          doi ? 'https://doi.org/' + doi : (paper.url || ''),
          '', paper.abstract || '', detectLang(paper.title), 'Semantic Scholar'
        ));
      } catch(e) {}
    }
  } catch(e) { logError('Semantic Scholar', e.message); }
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOURCE 6: Internet Archive âœ…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcInternetArchive(query) {
  const books = [];
  try {
    const yr = new Date().getFullYear();
    const url = 'https://archive.org/advancedsearch.php?q=' +
      encodeURIComponent(query) + '+mediatype:texts+year:[' + (yr-1) + ' TO ' + yr +
      ']&fl[]=identifier&fl[]=title&fl[]=creator&fl[]=publisher&fl[]=date&fl[]=year&fl[]=description&rows=15&output=json';
    const resp = await fetchWithTimeout(url);
    if (!resp.ok) return books;
    const data = await resp.json();
    for (const doc of ((data.response || {}).docs || [])) {
      try {
        if (!doc.title) continue;
        const pd = doc.date || (doc.year ? doc.year + '-01-01' : '');
        if (!isRecent(pd)) continue;
        const auths = doc.creator ? [].concat(doc.creator) : [];
        if (!isAfricaBook(doc.title, doc.description || '', auths)) continue;
        const pub = Array.isArray(doc.publisher) ? doc.publisher[0] : (doc.publisher || '');
        books.push(mkBook(
          'ia_' + doc.identifier, doc.title, auths, pub, pd, null, '',
          'https://archive.org/details/' + doc.identifier,
          'https://archive.org/services/img/' + doc.identifier,
          (doc.description || '').substring(0, 300),
          detectLang(doc.title), 'Internet Archive'
        ));
      } catch(e) {}
    }
  } catch(e) { logError('Internet Archive', e.message); }
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOURCE 7: Library of Congress âœ…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcLOC(query) {
  const books = [];
  try {
    const resp = await fetchWithTimeout(
      'https://www.loc.gov/books/?q=' + encodeURIComponent(query) + '&fo=json&c=15'
    );
    if (!resp.ok) return books;
    const data = await resp.json();
    for (const item of (data.results || [])) {
      try {
        const title = item.title;
        if (!title) continue;
        const dates = [].concat(item.date || []);
        const dateStr = dates[0] || '';
        const yr = parseInt(dateStr);
        const pd = yr ? yr + '-01-01' : '';
        if (pd && !isRecent(pd)) continue;
        const auths = [].concat(item.contributor || []).map(c => typeof c === 'string' ? c : '');
        const desc = Array.isArray(item.description) ? item.description.join(' ') : '';
        if (!isAfricaBook(title, desc, auths)) continue;
        const imgUrl = item.image_url ? (Array.isArray(item.image_url) ? item.image_url[0] : item.image_url) : '';
        books.push(mkBook(
          'loc_' + Math.random().toString(36).substr(2,8),
          title, auths.filter(Boolean), '', pd, null, '',
          item.url || item.id || '', imgUrl, '',
          detectLang(title), 'Library of Congress'
        ));
      } catch(e) {}
    }
  } catch(e) { logError('LOC', e.message); }
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOURCE 8: DOAB (Open Access Books) âœ… Fixed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcDOAB(query) {
  const books = [];
  try {
    // DOAB uses a different API endpoint
    const resp = await fetchWithTimeout(
      'https://directory.doabooks.org/rest/search?query=' +
      encodeURIComponent(query) + '&expand=metadata&limit=15',
      { headers: { Accept: 'application/json' } }
    );
    if (!resp.ok) return books;
    let data;
    try { data = await resp.json(); } catch(e) { return books; }

    const items = Array.isArray(data) ? data : (data.items || data.results || data.records || []);
    for (const item of items.slice(0, 15)) {
      try {
        let title = '', auths = [], pub = '', pd = '', desc = '', isbn = '', url = '';

        // Try metadata array
        const meta = item.metadata || (item.expand && item.expand.metadata) || [];
        if (Array.isArray(meta) && meta.length > 0) {
          for (const m of meta) {
            const k = m.key || '';
            const v = m.value || '';
            if (k.includes('title') && !title) title = v;
            if (k.includes('author') || k.includes('creator')) auths.push(v);
            if (k.includes('publisher') && !pub) pub = v;
            if (k.includes('date') && !pd) pd = v;
            if (k.includes('abstract') || k.includes('description')) desc += v + ' ';
            if (k.includes('isbn') && !isbn) isbn = v;
            if (k.includes('uri') && !url) url = v;
          }
        } else {
          title = item.title || item.name || '';
          auths = item.authors ? [].concat(item.authors) : [];
          pub = item.publisher || '';
          pd = item.date || item.year || '';
          desc = item.description || '';
        }

        if (!title) continue;
        if (pd && pd.length === 4) pd += '-01-01';
        if (pd && !isRecent(pd)) continue;
        if (!isAfricaBook(title, desc, auths)) continue;

        books.push(mkBook(
          'doab_' + (item.uuid || item.id || Math.random().toString(36).substr(2,8)),
          title, auths, pub, pd, null, isbn, url || '', '', desc.trim(),
          detectLang(title), 'DOAB'
        ));
      } catch(e) {}
    }
  } catch(e) { logError('DOAB', e.message); }
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOURCE 9: OAPEN Library âœ… Fixed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcOAPEN(query) {
  const books = [];
  try {
    const resp = await fetchWithTimeout(
      'https://library.oapen.org/rest/search?query=' +
      encodeURIComponent(query) + '&expand=metadata&limit=15',
      { headers: { Accept: 'application/json' } }
    );
    if (!resp.ok) return books;
    let data;
    try { data = await resp.json(); } catch(e) { return books; }

    const items = Array.isArray(data) ? data : (data.items || data.results || []);
    for (const item of items.slice(0, 15)) {
      try {
        let title = '', auths = [], pub = '', pd = '', desc = '', isbn = '', url = '';

        const meta = item.metadata || [];
        if (Array.isArray(meta) && meta.length > 0) {
          for (const m of meta) {
            const k = m.key || '';
            const v = m.value || '';
            if (k.includes('title') && !title) title = v;
            if (k.includes('author') || k.includes('creator')) auths.push(v);
            if (k.includes('publisher') && !pub) pub = v;
            if (k.includes('date.issued') && !pd) pd = v;
            if (k.includes('abstract')) desc += v + ' ';
            if (k.includes('isbn') && !isbn) isbn = v;
            if (k.includes('uri') && !url) url = v;
          }
        } else {
          title = item.title || item.name || '';
        }

        if (!title) continue;
        if (pd && pd.length === 4) pd += '-01-01';
        if (pd && !isRecent(pd)) continue;
        if (!isAfricaBook(title, desc, auths)) continue;

        books.push(mkBook(
          'oapen_' + (item.uuid || Math.random().toString(36).substr(2,8)),
          title, auths, pub, pd, null, isbn, url || '', '', desc.trim(),
          detectLang(title), 'OAPEN'
        ));
      } catch(e) {}
    }
  } catch(e) { logError('OAPEN', e.message); }
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOURCE 10: OpenAlex Concepts (African Studies) âœ…
// Uses OpenAlex concept filter for African Studies specifically
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcOpenAlexConcepts() {
  const books = [];
  try {
    // Concept ID for "African studies" in OpenAlex
    const p = new URLSearchParams({
      filter: 'type:book,concepts.id:C162118730,from_publication_date:' + getMinDateISO(),
      per_page: '30',
      sort: 'publication_date:desc'
    });
    const resp = await fetchWithTimeout(
      'https://api.openalex.org/works?' + p,
      { headers: { 'User-Agent': 'mailto:test@example.com' } }
    );
    if (!resp.ok) return books;
    const data = await resp.json();
    for (const w of (data.results || [])) {
      try {
        const title = w.title || w.display_name;
        if (!title) continue;
        const pd = w.publication_date;
        if (!pd || !isRecent(pd)) continue;
        const auths = (w.authorships || []).map(a => (a.author || {}).display_name || '').filter(Boolean);
        const doi = w.doi ? w.doi.replace('https://doi.org/', '') : '';
        books.push(mkBook(
          'oac_' + (w.id || ''),
          title, auths,
          ((w.primary_location || {}).source || {}).display_name || '',
          pd, null, '',
          doi ? 'https://doi.org/' + doi : (w.id || ''),
          '', '', detectLang(title), 'OpenAlex Concepts'
        ));
      } catch(e) {}
    }
  } catch(e) { logError('OpenAlex Concepts', e.message); }
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchAllBooks() {
  if (isUpdating) return;
  isUpdating = true;
  activeSources.clear();
  errorLog = [];
  document.getElementById('elog').style.display = 'none';

  const prevCount = ALL_BOOKS.length;
  document.getElementById('pbar').style.display = 'block';
  document.getElementById('rBtn').disabled = true;

  if (ALL_BOOKS.length === 0) {
    document.getElementById('grid').innerHTML =
      '<div class="loader"><div class="spinner"></div><p>Ø¬Ø§Ø± Ø¬Ù„Ø¨ Ø§Ù„ÙƒØªØ¨ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ø±...</p></div>';
  }

  const allNew = [];
  const tasks = [];

  // Build task list
  // Google Books (main source, careful with rate limiting)
  const gEn = Q.en.slice(0, 30);
  const gFr = Q.fr.slice(0, 20);
  const gAr = Q.ar.slice(0, 15);
  for (const q of gEn) tasks.push({ fn: () => srcGoogleBooks(q,'en'), name:'Google Books', label: q });
  for (const q of gFr) tasks.push({ fn: () => srcGoogleBooks(q,'fr'), name:'Google Books', label: q });
  for (const q of gAr) tasks.push({ fn: () => srcGoogleBooks(q,'ar'), name:'Google Books', label: q });

  // Open Library
  for (const q of Q.en.slice(0,15)) tasks.push({ fn: () => srcOpenLibrary(q), name:'Open Library', label: q });
  for (const q of Q.fr.slice(0,10)) tasks.push({ fn: () => srcOpenLibrary(q), name:'Open Library', label: q });
  for (const q of Q.ar.slice(0,8)) tasks.push({ fn: () => srcOpenLibrary(q), name:'Open Library', label: q });

  // Crossref
  for (const q of Q.en.slice(0,12)) tasks.push({ fn: () => srcCrossref(q), name:'Crossref', label: q });
  for (const q of Q.fr.slice(0,8)) tasks.push({ fn: () => srcCrossref(q), name:'Crossref', label: q });

  // OpenAlex
  for (const q of Q.en.slice(0,12)) tasks.push({ fn: () => srcOpenAlex(q), name:'OpenAlex', label: q });
  for (const q of Q.fr.slice(0,8)) tasks.push({ fn: () => srcOpenAlex(q), name:'OpenAlex', label: q });

  // OpenAlex Concepts (one call)
  tasks.push({ fn: () => srcOpenAlexConcepts(), name:'OpenAlex Concepts', label: 'African Studies concept' });

  // Semantic Scholar (strict rate limiting)
  for (const q of Q.en.slice(0,8)) tasks.push({ fn: () => srcSemanticScholar(q), name:'Semantic Scholar', label: q });

  // Internet Archive
  for (const q of Q.en.slice(0,8)) tasks.push({ fn: () => srcInternetArchive(q), name:'Internet Archive', label: q });
  for (const q of Q.fr.slice(0,5)) tasks.push({ fn: () => srcInternetArchive(q), name:'Internet Archive', label: q });

  // LOC
  for (const q of Q.en.slice(0,6)) tasks.push({ fn: () => srcLOC(q), name:'LOC', label: q });

  // DOAB
  for (const q of Q.en.slice(0,6)) tasks.push({ fn: () => srcDOAB(q), name:'DOAB', label: q });
  for (const q of Q.fr.slice(0,4)) tasks.push({ fn: () => srcDOAB(q), name:'DOAB', label: q });

  // OAPEN
  for (const q of Q.en.slice(0,6)) tasks.push({ fn: () => srcOAPEN(q), name:'OAPEN', label: q });
  for (const q of Q.fr.slice(0,4)) tasks.push({ fn: () => srcOAPEN(q), name:'OAPEN', label: q });

  const total = tasks.length;
  let done = 0;

  // Process in batches of 2 to avoid rate limits
  for (let i = 0; i < tasks.length; i += 2) {
    const batch = tasks.slice(i, i + 2);
    const results = await Promise.allSettled(
      batch.map(async t => {
        try {
          const res = await t.fn();
          if (res && res.length > 0) {
            activeSources.set(t.name, (activeSources.get(t.name) || 0) + res.length);
            allNew.push(...res);
          }
          return res;
        } catch(e) {
          logError(t.name, e.message);
          return [];
        }
      })
    );

    done += batch.length;
    const pct = Math.round((done / total) * 100);
    document.getElementById('pfill').style.width = pct + '%';
    document.getElementById('ptxt').textContent =
      pct + '% | ' + batch[0].name + ': ' + batch[0].label.substring(0, 25) + '...';

    // Live update every 20 tasks
    if (allNew.length > 0 && done % 20 === 0) {
      const temp = dedup([...ALL_BOOKS, ...allNew]);
      temp.sort((a,b) => new Date(b.publication_date) - new Date(a.publication_date));
      ALL_BOOKS = temp;
      updateStats(); filterBooks(); updateSourcesUI();
    }

    // Different delays based on source
    const currentSrc = batch[0].name;
    let delay = 400;
    if (currentSrc === 'Google Books') delay = 800;
    else if (currentSrc === 'Semantic Scholar') delay = 1500;
    else if (currentSrc === 'Crossref') delay = 600;
    await sleep(delay);
  }

  // Final merge
  ALL_BOOKS = dedup([...ALL_BOOKS, ...allNew]);
  ALL_BOOKS.sort((a,b) => new Date(b.publication_date) - new Date(a.publication_date));
  const addedCount = ALL_BOOKS.length - prevCount;

  // Save cache
  try {
    localStorage.setItem(CACHE_KEY, JSON.stringify({
      books: ALL_BOOKS.slice(0, 500), // limit cache size
      timestamp: Date.now(),
      sources: Object.fromEntries(activeSources)
    }));
  } catch(e) {}

  document.getElementById('pbar').style.display = 'none';
  document.getElementById('rBtn').disabled = false;
  isUpdating = false;

  updateStats(); filterBooks(); updateTime(); updateSourcesUI(); updateSourceFilter();

  if (addedCount > 0 && prevCount > 0) {
    showNotif('ØªÙ… Ø¥Ø¶Ø§ÙØ© ' + addedCount + ' ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† ' + activeSources.size + ' Ù…ØµØ¯Ø±!');
  }

  console.log('âœ… Total books:', ALL_BOOKS.length, '| Sources:', activeSources.size, '| Errors:', errorLog.length);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI Functions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSourcesUI() {
  const allSrc = ['Google Books','Open Library','Crossref','OpenAlex','OpenAlex Concepts',
    'Semantic Scholar','Internet Archive','LOC','DOAB','OAPEN'];
  const html = allSrc.map(s => {
    const count = activeSources.get(s) || 0;
    const on = count > 0;
    return '<span class="src-tag"><span class="dot '+(on?'on':'off')+'"></span>' +
      s + (on ? ' ('+count+')' : '') + '</span>';
  }).join('');
  document.getElementById('srcStats').innerHTML = '<div class="src-grid">' + html + '</div>';
}

function updateSourceFilter() {
  const sel = document.getElementById('srcSel');
  const current = sel.value;
  const sources = [...new Set(ALL_BOOKS.map(b => b.source))].sort();
  sel.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„ (' + sources.length + ')</option>';
  sources.forEach(s => {
    const count = ALL_BOOKS.filter(b => b.source === s).length;
    sel.innerHTML += '<option value="' + esc(s) + '">' + esc(s) + ' (' + count + ')</option>';
  });
  sel.value = current;
}

function setLang(lang, btn) {
  currentLang = lang;
  document.querySelectorAll('.fbtn').forEach(b => b.className = 'fbtn');
  if (lang === 'all') btn.classList.add('active');
  else btn.classList.add('a-' + lang);
  filterBooks();
}

function filterBooks() {
  const search = document.getElementById('searchInput').value.toLowerCase().trim();
  const topic = document.getElementById('topicSel').value;
  const src = document.getElementById('srcSel').value;
  const sort = document.getElementById('sortSel').value;

  let list = ALL_BOOKS.filter(b => {
    if (currentLang !== 'all' && b.language !== currentLang) return false;
    if (topic && !b.topics.some(t => t.toLowerCase().includes(topic.toLowerCase()))) return false;
    if (src && b.source !== src) return false;
    if (search) {
      const hay = (b.title + ' ' + b.authors.join(' ') + ' ' + b.publisher + ' ' + (b.description||'')).toLowerCase();
      if (!hay.includes(search)) return false;
    }
    return true;
  });

  switch(sort) {
    case 'newest': list.sort((a,b) => new Date(b.publication_date) - new Date(a.publication_date)); break;
    case 'oldest': list.sort((a,b) => new Date(a.publication_date) - new Date(b.publication_date)); break;
    case 'title': list.sort((a,b) => a.title.localeCompare(b.title)); break;
  }

  renderBooks(list);
}

function renderBooks(books) {
  const grid = document.getElementById('grid');

  if (!books.length && ALL_BOOKS.length === 0) {
    grid.innerHTML = '<div class="loader"><div class="spinner"></div><p>Ø¬Ø§Ø± Ø¬Ù„Ø¨ Ø§Ù„ÙƒØªØ¨...</p></div>';
    return;
  }
  if (!books.length) {
    grid.innerHTML = '<div class="no-res"><div class="emoji">ğŸŒ</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ù…Ø·Ø§Ø¨Ù‚Ø©</p></div>';
    return;
  }

  const hotTopics = ['Conflict','Terrorism','Sahel','Security','Coups','Refugees','Migration'];

  grid.innerHTML = books.map(b => {
    const lc = 'l-' + b.language;
    const ll = b.language === 'ar' ? 'Ø¹Ø±Ø¨ÙŠ' : b.language === 'fr' ? 'FranÃ§ais' : 'English';
    const date = fmtDate(b.publication_date);

    const coverHTML = b.cover
      ? '<img src="' + esc(b.cover) + '" alt="" loading="lazy" onerror="this.onerror=null;this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'"><div class="no-cover" style="display:none">ğŸŒ</div>'
      : '<div class="no-cover">ğŸŒ</div>';

    const tags = b.topics.slice(0,4).map(t =>
      '<span class="tag ' + (hotTopics.some(h => t.includes(h)) ? 'hot' : '') + '">' + esc(t) + '</span>'
    ).join('');

    return '<div class="book-card">' +
      '<div class="cover-wrap">' + coverHTML +
      '<span class="lang-badge ' + lc + '">' + ll + '</span>' +
      '<span class="src-badge">' + esc(b.source) + '</span>' +
      '</div>' +
      '<div class="book-body">' +
      '<div class="book-title">' + esc(b.title) + '</div>' +
      '<div class="book-author">' + esc(b.authors.slice(0,3).join(', ') || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') + '</div>' +
      '<div class="book-pub">' + esc(b.publisher || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') + '</div>' +
      '<div class="book-meta">' +
      (date ? '<span>ğŸ“… ' + date + '</span>' : '') +
      (b.pages ? '<span>ğŸ“„ ' + b.pages + '</span>' : '') +
      (b.isbn ? '<span>ğŸ“‹ ISBN</span>' : '') +
      '</div>' +
      '<div class="topics">' + tags + '</div>' +
      (b.description ? '<div class="book-desc">' + esc(b.description) + '</div>' : '') +
      '<div class="book-actions">' +
      (b.book_url ? '<a href="' + esc(b.book_url) + '" target="_blank" rel="noopener" class="blink bp">ğŸ”— Ø§Ù„ÙƒØªØ§Ø¨</a>' : '') +
      (b.isbn ? '<a href="https://www.worldcat.org/isbn/' + esc(b.isbn) + '" target="_blank" rel="noopener" class="blink bs">ğŸ“š WorldCat</a>' : '') +
      '</div></div></div>';
  }).join('');
}

function updateStats() {
  document.getElementById('sTotal').textContent = ALL_BOOKS.length;
  document.getElementById('sAr').textContent = ALL_BOOKS.filter(b => b.language === 'ar').length;
  document.getElementById('sEn').textContent = ALL_BOOKS.filter(b => b.language === 'en').length;
  document.getElementById('sFr').textContent = ALL_BOOKS.filter(b => b.language === 'fr').length;
  document.getElementById('sPub').textContent = new Set(ALL_BOOKS.map(b => b.publisher).filter(Boolean)).size;
  document.getElementById('sSrc').textContent = activeSources.size;
}

function updateTime() {
  document.getElementById('lastUp').textContent = 'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' + fmtNow();
}

function manualRefresh() {
  localStorage.removeItem(CACHE_KEY);
  ALL_BOOKS = [];
  fetchAllBooks();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function init() {
  // Try loading cache first
  try {
    const raw = localStorage.getItem(CACHE_KEY);
    if (raw) {
      const cache = JSON.parse(raw);
      if (cache && cache.books && cache.books.length > 0) {
        ALL_BOOKS = cache.books;
        if (cache.sources) {
          Object.entries(cache.sources).forEach(([k,v]) => activeSources.set(k, v));
        }
        updateStats(); filterBooks(); updateTime(); updateSourcesUI(); updateSourceFilter();

        const elapsed = Date.now() - (cache.timestamp || 0);
        if (elapsed < DAY_MS) {
          console.log('ğŸ“¦ Using cache, next refresh in', Math.round((DAY_MS - elapsed)/60000), 'min');
          setTimeout(() => fetchAllBooks(), DAY_MS - elapsed);
          return;
        }
      }
    }
  } catch(e) { console.error('Cache error:', e); }

  await fetchAllBooks();
})();

// Auto-refresh daily
setInterval(() => fetchAllBooks(), DAY_MS);
</script>
</body>
</html>
