<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø±ØµØ¯ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© â€” Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ© ÙˆØ§Ù„Ø¹Ø±Ø¨ÙŠØ©</title>
<style>
  /* ï¿½ï¿½ï¿½â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CSS Ù…ØªÙƒØ§Ù…Ù„ â€” Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù…ÙƒØªØ¨Ø© Ø®Ø§Ø±Ø¬ÙŠØ©
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  * { margin:0; padding:0; box-sizing:border-box; }

  :root {
    --bg: #f0f2f5;
    --card: #ffffff;
    --text: #1a1a2e;
    --text2: #555;
    --accent: #0d7377;
    --accent2: #14919b;
    --gold: #d4a017;
    --ar: #059669;
    --fr: #2563eb;
    --en: #7c3aed;
    --shadow: 0 2px 20px rgba(0,0,0,.06);
    --radius: 16px;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
  }

  /* â”€â”€ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© â”€â”€ */
  .hero {
    background: linear-gradient(135deg, #0d1117 0%, #0d7377 50%, #14919b 100%);
    color: white;
    padding: 40px 20px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .hero::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,.03) 0%, transparent 70%);
    animation: pulse 8s ease-in-out infinite;
  }
  @keyframes pulse {
    0%,100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }
  .hero h1 { font-size: 2.2em; font-weight: 800; position: relative; }
  .hero p { font-size: 1.1em; opacity: .85; margin-top: 8px; position: relative; }
  .hero .badges { display: flex; gap: 10px; justify-content: center; margin-top: 16px; position: relative; flex-wrap: wrap; }
  .hero .badge {
    padding: 6px 18px;
    border-radius: 30px;
    font-size: .85em;
    font-weight: 600;
    border: 1px solid rgba(255,255,255,.2);
    background: rgba(255,255,255,.1);
    backdrop-filter: blur(4px);
  }

  /* â”€â”€ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª â”€â”€ */
  .stats-bar {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    max-width: 1400px;
    margin: -30px auto 0;
    padding: 0 20px;
    position: relative;
    z-index: 2;
  }
  .stat-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 20px 16px;
    text-align: center;
    box-shadow: var(--shadow);
    border: 1px solid rgba(0,0,0,.04);
  }
  .stat-card .num { font-size: 1.8em; font-weight: 800; }
  .stat-card .lbl { font-size: .8em; color: var(--text2); margin-top: 2px; }

  /* â”€â”€ Ø§Ù„ÙÙ„Ø§ØªØ± â”€â”€ */
  .controls {
    max-width: 1400px;
    margin: 24px auto;
    padding: 0 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
  }
  .search-box {
    flex: 1;
    min-width: 250px;
    padding: 12px 20px;
    border-radius: 50px;
    border: 2px solid #e0e0e0;
    font-size: 1em;
    outline: none;
    transition: border .3s;
    direction: rtl;
  }
  .search-box:focus { border-color: var(--accent); }

  .filter-btn {
    padding: 10px 22px;
    border-radius: 50px;
    border: 2px solid #e0e0e0;
    background: var(--card);
    cursor: pointer;
    font-size: .9em;
    font-weight: 600;
    transition: all .3s;
  }
  .filter-btn:hover { border-color: var(--accent); color: var(--accent); }
  .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
  .filter-btn.active-ar { background: var(--ar); color: white; border-color: var(--ar); }
  .filter-btn.active-fr { background: var(--fr); color: white; border-color: var(--fr); }
  .filter-btn.active-en { background: var(--en); color: white; border-color: var(--en); }

  /* â”€â”€ Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ø¯ÙŠØ« â”€â”€ */
  .update-bar {
    max-width: 1400px;
    margin: 0 auto 16px;
    padding: 0 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
  }
  .update-bar span { font-size: .85em; color: var(--text2); }
  .update-bar .live {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: .85em;
    color: var(--accent);
    font-weight: 600;
  }
  .live-dot {
    width: 8px;
    height: 8px;
    background: #10b981;
    border-radius: 50%;
    animation: blink 2s ease-in-out infinite;
  }
  @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:.3;} }

  .refresh-btn {
    padding: 8px 20px;
    border-radius: 50px;
    border: none;
    background: var(--accent);
    color: white;
    cursor: pointer;
    font-size: .85em;
    font-weight: 600;
    transition: background .3s;
  }
  .refresh-btn:hover { background: var(--accent2); }
  .refresh-btn:disabled { opacity: .5; cursor: not-allowed; }

  /* â”€â”€ Ø´Ø¨ÙƒØ© Ø§Ù„ÙƒØªØ¨ â”€â”€ */
  .books-grid {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 20px 40px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
  }

  /* â”€â”€ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙƒØªØ§Ø¨ â”€â”€ */
  .book-card {
    background: var(--card);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
    border: 1px solid rgba(0,0,0,.04);
    transition: transform .3s, box-shadow .3s;
    display: flex;
    flex-direction: column;
  }
  .book-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 30px rgba(0,0,0,.12);
  }

  .book-cover-wrap {
    position: relative;
    height: 220px;
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  .book-cover-wrap img {
    height: 190px;
    max-width: 140px;
    object-fit: cover;
    border-radius: 6px;
    box-shadow: 4px 4px 20px rgba(0,0,0,.4);
    transition: transform .3s;
  }
  .book-card:hover .book-cover-wrap img { transform: scale(1.05); }

  .lang-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    padding: 4px 14px;
    border-radius: 20px;
    font-size: .75em;
    font-weight: 700;
    color: white;
  }
  .lang-ar { background: var(--ar); }
  .lang-fr { background: var(--fr); }
  .lang-en { background: var(--en); }

  .source-badge {
    position: absolute;
    bottom: 10px;
    left: 10px;
    padding: 3px 10px;
    border-radius: 10px;
    font-size: .65em;
    background: rgba(255,255,255,.15);
    color: rgba(255,255,255,.8);
    backdrop-filter: blur(4px);
  }

  .book-body {
    padding: 18px;
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  .book-title {
    font-size: 1.05em;
    font-weight: 700;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 8px;
  }
  .book-author {
    font-size: .9em;
    color: var(--accent);
    font-weight: 600;
    margin-bottom: 4px;
  }
  .book-publisher {
    font-size: .82em;
    color: var(--text2);
    margin-bottom: 8px;
  }
  .book-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    font-size: .78em;
    color: var(--text2);
    margin-bottom: 10px;
  }
  .book-meta span { display: flex; align-items: center; gap: 4px; }

  .book-topics {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 12px;
  }
  .topic-tag {
    padding: 3px 12px;
    border-radius: 20px;
    font-size: .72em;
    background: #f0f7f7;
    color: var(--accent);
    font-weight: 500;
  }

  .book-desc {
    font-size: .82em;
    color: var(--text2);
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 12px;
  }

  .book-actions {
    margin-top: auto;
    display: flex;
    gap: 8px;
  }
  .btn-link {
    flex: 1;
    padding: 10px;
    text-align: center;
    border-radius: 12px;
    font-size: .85em;
    font-weight: 600;
    text-decoration: none;
    transition: all .3s;
  }
  .btn-primary {
    background: var(--text);
    color: white;
  }
  .btn-primary:hover { background: var(--accent); }
  .btn-secondary {
    background: #f5f5f5;
    color: var(--text);
    border: 1px solid #e0e0e0;
  }
  .btn-secondary:hover { background: #eee; }

  /* â”€â”€ Ø§Ù„ØªØ­Ù…ÙŠÙ„ â”€â”€ */
  .loader {
    text-align: center;
    padding: 60px;
    grid-column: 1 / -1;
  }
  .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #e0e0e0;
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .no-results {
    text-align: center;
    padding: 60px;
    grid-column: 1 / -1;
    color: var(--text2);
  }
  .no-results .emoji { font-size: 4em; margin-bottom: 12px; }

  /* â”€â”€ Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù… â”€â”€ */
  .progress-bar {
    max-width: 1400px;
    margin: 0 auto 12px;
    padding: 0 20px;
  }
  .progress-track {
    height: 4px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 4px;
    transition: width .5s;
  }
  .progress-text {
    font-size: .78em;
    color: var(--text2);
    margin-top: 4px;
    text-align: center;
  }

  /* â”€â”€ Footer â”€â”€ */
  footer {
    text-align: center;
    padding: 30px 20px;
    font-size: .8em;
    color: var(--text2);
    border-top: 1px solid #e0e0e0;
    max-width: 1400px;
    margin: 0 auto;
  }

  .sources-toggle {
    background: none;
    border: 1px solid #ddd;
    padding: 6px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: .85em;
    margin-top: 8px;
    color: var(--accent);
    font-weight: 600;
  }
  .sources-list {
    display: none;
    max-width: 1200px;
    margin: 12px auto;
    text-align: right;
    font-size: .78em;
    color: var(--text2);
    line-height: 2;
    columns: 3;
    column-gap: 30px;
    padding: 0 20px;
  }
  .sources-list.open { display: block; }

  @media (max-width: 768px) {
    .hero h1 { font-size: 1.5em; }
    .books-grid { grid-template-columns: 1fr; }
    .stats-bar { grid-template-columns: repeat(3, 1fr); }
    .sources-list { columns: 1; }
  }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="hero">
  <h1>ğŸ“š Ù…Ø±ØµØ¯ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h1>
  <p>Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ© ÙˆØ§Ù„Ø¹Ø±Ø¨ÙŠØ© â€” ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ Ø³Ø§Ø¹Ø© Ù…Ù† Ù…ØµØ§Ø¯Ø± Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ù…ØªØ¹Ø¯Ø¯Ø©</p>
  <div class="badges">
    <span class="badge">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>
    <span class="badge">ğŸ‡«ğŸ‡· FranÃ§ais</span>
    <span class="badge">ğŸ‡¬ğŸ‡§ English</span>
    <span class="badge">â±ï¸ ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø³Ø§Ø¹Ø©</span>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="stats-bar" id="statsBar">
  <div class="stat-card"><div class="num" id="totalCount">-</div><div class="lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØªØ¨</div></div>
  <div class="stat-card"><div class="num" id="arCount" style="color:var(--ar)">-</div><div class="lbl">ğŸ‡¸ğŸ‡¦ Ø¹Ø±Ø¨ÙŠ</div></div>
  <div class="stat-card"><div class="num" id="frCount" style="color:var(--fr)">-</div><div class="lbl">ğŸ‡«ğŸ‡· ÙØ±Ù†Ø³ÙŠ</div></div>
  <div class="stat-card"><div class="num" id="enCount" style="color:var(--en)">-</div><div class="lbl">ğŸ‡¬ğŸ‡§ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</div></div>
  <div class="stat-card"><div class="num" id="sourceCount" style="color:var(--gold)">-</div><div class="lbl">ğŸ“¡ Ø§Ù„Ù…Ø±Ø§ØµØ¯</div></div>
  <div class="stat-card"><div class="num" id="pubCount">-</div><div class="lbl">ğŸ¢ Ø§Ù„Ù†Ø§Ø´Ø±ÙˆÙ†</div></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Ø§Ù„ÙÙ„Ø§ØªØ± â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="controls">
  <input type="text" class="search-box" id="searchInput" placeholder="ğŸ”  Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒØªØ§Ø¨ØŒ Ù…Ø¤Ù„ÙØŒ Ø£Ùˆ Ù†Ø§Ø´Ø±..." oninput="filterBooks()">
  <button class="filter-btn active" onclick="setLang('all',this)">Ø§Ù„ÙƒÙ„</button>
  <button class="filter-btn" onclick="setLang('ar',this)">ğŸ‡¸ğŸ‡¦ Ø¹Ø±Ø¨ÙŠ</button>
  <button class="filter-btn" onclick="setLang('fr',this)">ğŸ‡«ğŸ‡· ÙØ±Ù†Ø³ÙŠ</button>
  <button class="filter-btn" onclick="setLang('en',this)">ğŸ‡¬ğŸ‡§ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</button>
  <select class="search-box" style="flex:none;width:200px;border-radius:50px" id="topicSelect" onchange="filterBooks()">
    <option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹</option>
    <option value="Africa">Ø£ÙØ±ÙŠÙ‚ÙŠØ§</option>
    <option value="North Africa">Ø´Ù…Ø§Ù„ Ø£ÙØ±ÙŠÙ‚ÙŠØ§</option>
    <option value="Sahel">Ø§Ù„Ø³Ø§Ø­Ù„</option>
    <option value="Arab">Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ</option>
    <option value="Middle East">Ø§Ù„Ø´Ø±Ù‚ Ø§Ù„Ø£ÙˆØ³Ø·</option>
    <option value="Gulf">Ø§Ù„Ø®Ù„ÙŠØ¬</option>
    <option value="Palestine">ÙÙ„Ø³Ø·ÙŠÙ†</option>
    <option value="Sudan">Ø§Ù„Ø³ÙˆØ¯Ø§Ù†</option>
    <option value="Migration">Ø§Ù„Ù‡Ø¬Ø±Ø©</option>
    <option value="Security">Ø§Ù„Ø£Ù…Ù†</option>
    <option value="Development">Ø§Ù„ØªÙ†Ù…ÙŠØ©</option>
    <option value="Politics">Ø§Ù„Ø³ÙŠØ§Ø³Ø©</option>
  </select>
  <select class="search-box" style="flex:none;width:180px;border-radius:50px" id="sortSelect" onchange="filterBooks()">
    <option value="date">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
    <option value="title">Ø£Ø¨Ø¬Ø¯ÙŠ (Ø§Ù„Ø¹Ù†ÙˆØ§Ù†)</option>
    <option value="pages">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª</option>
  </select>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ø¯ÙŠØ« â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="update-bar">
  <div class="live"><span class="live-dot"></span> ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ Ø³Ø§Ø¹Ø©</div>
  <span id="lastUpdate">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
  <button class="refresh-btn" id="refreshBtn" onclick="manualRefresh()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="progress-bar" id="progressBar" style="display:none">
  <div class="progress-track"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
  <div class="progress-text" id="progressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø±Ø§ØµØ¯...</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Ø´Ø¨ÙƒØ© Ø§Ù„ÙƒØªØ¨ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="books-grid" id="booksGrid">
  <div class="loader"><div class="spinner"></div><p>Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„ÙƒØªØ¨ Ù…Ù† Ø§Ù„Ù…Ø±Ø§ØµØ¯...</p></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Footer â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<footer>
  <p>Ù…Ø±ØµØ¯ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© â€” Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ© ÙˆØ§Ù„Ø¹Ø±Ø¨ÙŠØ© Â© 2025-2026</p>
  <p>ÙŠØ¬Ù…Ø¹ Ø§Ù„ÙƒØªØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† ÙˆØ§Ø¬Ù‡Ø§Øª Google Books Ùˆ Open Library Ùˆ Crossref Ùˆ DOAB</p>
  <button class="sources-toggle" onclick="toggleSources()">ğŸ“¡ Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§ØµØ¯ Ø§Ù„Ù€ 55+</button>
  <div class="sources-list" id="sourcesList"></div>
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ â€” ÙŠØ¹Ù…Ù„ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø¨Ø§Ø´Ø±Ø© (Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ±)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let ALL_BOOKS = [];
let currentLang = 'all';

// â”€â”€â”€ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§ØµØ¯ (55+) â”€â”€â”€
const SOURCES_LIST = [
  // (A) APIs Ù…Ø¨Ø§Ø´Ø±Ø© (ÙŠØ³ØªØ®Ø¯Ù…Ù‡Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙØ¹Ù„ÙŠÙ‹Ø§)
  "Google Books API","Open Library API","Crossref API","DOAB (Open Access Books)",
  // (B) Ù†Ø§Ø´Ø±ÙˆÙ† Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠÙˆÙ† ÙƒØ¨Ø§Ø± EN
  "Oxford University Press","Cambridge University Press","Princeton University Press",
  "Harvard University Press","Columbia University Press","Cornell University Press",
  "University of Chicago Press","University of California Press","Yale University Press",
  "Stanford University Press","Duke University Press","MIT Press",
  "Manchester University Press","Edinburgh University Press","Bristol University Press",
  "Palgrave Macmillan","Springer","De Gruyter","Brill",
  "Routledge / Taylor & Francis","Bloomsbury Academic",
  // (C) Ù†Ø§Ø´Ø±ÙˆÙ† ÙØ±Ù†Ø³ÙŠÙˆÙ†
  "Karthala","Presses de Sciences Po","CNRS Ã‰ditions","La DÃ©couverte",
  "L'Harmattan","OpenEdition Books","Cairn.info",
  // (D) Ù†Ø§Ø´Ø±ÙˆÙ† Ù…ØªØ®ØµØµÙˆÙ†
  "Hurst Publishers","Lynne Rienner","James Currey / Boydell",
  "Africa World Press","Zed Books",
  // (E) Ø¹Ø±Ø¨ÙŠ
  "Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø£Ø¨Ø­Ø§Ø« ÙˆØ¯Ø±Ø§Ø³Ø© Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª","Ù…Ø±ÙƒØ² Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
  "Ø¯Ø§Ø± Ø§Ù„Ø³Ø§Ù‚ÙŠ","Ø¯Ø§Ø± Ø§Ù„ÙØ§Ø±Ø§Ø¨ÙŠ","Ø¯Ø§Ø± Ø§Ù„ØªÙ†ÙˆÙŠØ±","Ø¯Ø§Ø± Ø§Ù„Ø±Ø§ÙØ¯ÙŠÙ†",
  "Ù…Ø¯Ø§Ø±Ø§Øª Ù„Ù„Ø£Ø¨Ø­Ø§Ø« ÙˆØ§Ù„Ù†Ø´Ø±","Ø£ÙØ±ÙŠÙ‚ÙŠØ§ Ø§Ù„Ø´Ø±Ù‚","Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù‚ÙˆÙ…ÙŠ Ù„Ù„ØªØ±Ø¬Ù…Ø© (Ù…ØµØ±)",
  // (F) Ù…Ø±Ø§ØµØ¯ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª
  "LSE Review of Books","H-Net Africa","H-Net Middle East",
  "African Affairs Journal","Foreign Affairs","ROAPE",
  // (G) ÙÙ‡Ø§Ø±Ø³
  "WorldCat","BnF","JSTOR","Project MUSE","OAPEN","OpenAlex"
];

// â”€â”€â”€ Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø¨Ø­Ø« (Ù…ÙØ¹Ø¯Ù‘Ø© Ø¨Ø¯Ù‚Ø©) â”€â”€â”€
const QUERIES = {
  en: [
    "africa politics 2025","african development governance",
    "arab world geopolitics","middle east security 2025",
    "sahel conflict terrorism","north africa maghreb politics",
    "horn africa ethiopia somalia","gulf states diplomacy",
    "palestine conflict international","sudan crisis war",
    "african union peacekeeping","libya transition",
    "egypt politics economy","morocco western sahara",
    "nigeria security boko haram","kenya east africa development",
    "south africa politics economy","african migration europe",
    "arab spring aftermath legacy","islamism africa politics",
    "climate change africa adaptation","china africa relations",
    "decolonization africa history", "arab intellectual thought",
    "african literature contemporary"
  ],
  fr: [
    "afrique politique 2025","sahel sÃ©curitÃ© terrorisme",
    "monde arabe gÃ©opolitique","maghreb politique Ã©conomie",
    "afrique subsaharienne dÃ©veloppement","dÃ©colonisation afrique",
    "migration africaine europe","cÃ´te ivoire politique",
    "sÃ©nÃ©gal dÃ©mocratie","congo conflits ressources",
    "tunisie transition politique","algÃ©rie histoire politique",
    "Palestine conflit droit","Liban crise politique",
    "islam politique afrique","francophonie afrique",
    "Cameroun politique","Mali sÃ©curitÃ©", "Niger Sahel",
    "Maroc politique sociÃ©tÃ©"
  ],
  ar: [
    "Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©","Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„Ø³ÙŠØ§Ø³Ø©",
    "Ø§Ù„Ø´Ø±Ù‚ Ø§Ù„Ø£ÙˆØ³Ø· Ø§Ù„Ø¬ÙŠÙˆØ³ÙŠØ§Ø³ÙŠØ©","Ø§Ù„Ø³Ø§Ø­Ù„ Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ Ø§Ù„Ø£Ù…Ù†",
    "Ø´Ù…Ø§Ù„ Ø£ÙØ±ÙŠÙ‚ÙŠØ§ Ø§Ù„Ù…ØºØ±Ø¨ Ø§Ù„Ø¹Ø±Ø¨ÙŠ","Ø§Ù„Ù‚Ø±Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ",
    "Ø¯ÙˆÙ„ Ø§Ù„Ø®Ù„ÙŠØ¬ Ø§Ù„Ø¹Ø±Ø¨ÙŠ","Ø§Ù„Ù‚Ø¶ÙŠØ© Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠØ©",
    "Ø§Ù„Ø³ÙˆØ¯Ø§Ù† Ø§Ù„Ø£Ø²Ù…Ø©","Ø§Ù„Ù‡Ø¬Ø±Ø© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©",
    "Ø§Ù„ØªÙ†Ù…ÙŠØ© ÙÙŠ Ø£ÙØ±ÙŠÙ‚ÙŠØ§","Ø§Ù„Ø§Ø³ØªØ¹Ù…Ø§Ø± ÙˆÙ…Ø§ Ø¨Ø¹Ø¯Ù‡",
    "Ù…ØµØ± Ø§Ù„Ø³ÙŠØ§Ø³Ø©","Ù„ÙŠØ¨ÙŠØ§ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„","Ù„Ø¨Ù†Ø§Ù† Ø§Ù„Ø£Ø²Ù…Ø©",
    "Ø§Ù„Ø¯ÙŠÙ…Ù‚Ø±Ø§Ø·ÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ","Ø§Ù„Ø¥Ø³Ù„Ø§Ù… Ø§Ù„Ø³ÙŠØ§Ø³ÙŠ Ø£ÙØ±ÙŠÙ‚ÙŠØ§",
    "Ø§Ù„ØµØ±Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø³Ù„Ø­Ø© Ø£ÙØ±ÙŠÙ‚ÙŠØ§","Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©",
    "Ø§Ù„Ù†ÙØ· ÙˆØ§Ù„Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®Ù„ÙŠØ¬"
  ]
};

// â”€â”€â”€ ÙƒØ´Ù Ø§Ù„Ù„ØºØ© â”€â”€â”€
function detectLang(text) {
  if (!text) return 'en';
  if (/[\u0600-\u06FF]/.test(text)) return 'ar';
  if (/[Ã Ã¢Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã¿Ã§Å“Ã¦]/i.test(text)) return 'fr';
  const frWords = /\b(le|la|les|du|des|une?|est|dans|pour|avec|sur|entre|politique|histoire|sociÃ©tÃ©)\b/i;
  if (frWords.test(text)) return 'fr';
  return 'en';
}

// â”€â”€â”€ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª (Topics) â”€â”€â”€
function detectTopics(title, desc) {
  const text = ((title||'') + ' ' + (desc||'')).toLowerCase();
  const topics = [];
  const map = {
    'africa|afrique|Ø£ÙØ±ÙŠÙ‚|african': 'Africa',
    'north africa|maghreb|Ø§Ù„Ù…ØºØ±Ø¨|Ø´Ù…Ø§Ù„ Ø£ÙØ±ÙŠÙ‚|maghrÃ©bin': 'North Africa',
    'sahel|Ø³Ø§Ø­Ù„|mali|niger|burkina|tchad': 'Sahel',
    'arab|Ø¹Ø±Ø¨|arabe': 'Arab',
    'middle east|moyen.orient|Ø§Ù„Ø´Ø±Ù‚ Ø§Ù„Ø£ÙˆØ³Ø·': 'Middle East',
    'gulf|Ø®Ù„ÙŠØ¬|golfe|qatar|emirates|saudi|bahrain|kuwait|oman': 'Gulf',
    'palestin|ÙÙ„Ø³Ø·|gaza|hamas': 'Palestine',
    'sudan|Ø³ÙˆØ¯Ø§Ù†|soudan|darfur|khartoum': 'Sudan',
    'migrat|Ù‡Ø¬Ø±|diaspora': 'Migration',
    'securi|Ø£Ù…Ù†|terror|conflict|conflit|ØµØ±Ø§Ø¹|guerre|war|peace': 'Security',
    'develop|ØªÙ†Ù…ÙŠ|Ã©conomi|econom|Ø§Ù‚ØªØµØ§Ø¯|poverty': 'Development',
    'politi|Ø³ÙŠØ§Ø³|democra|Ø¯ÙŠÙ…Ù‚Ø±Ø§Ø·|govern|Ø­ÙƒÙ…|Ã©lection': 'Politics',
    'egypt|Ù…ØµØ±|Ã©gypt|cairo': 'Egypt',
    'libya|Ù„ÙŠØ¨ÙŠ|libye': 'Libya',
    'morocco|Ù…ØºØ±Ø¨|maroc': 'Morocco',
    'algeria|Ø¬Ø²Ø§Ø¦Ø±|algÃ©rie': 'Algeria',
    'tunisia|ØªÙˆÙ†Ø³|tunisie': 'Tunisia',
    'nigeria|Ù†ÙŠØ¬ÙŠØ±ÙŠ': 'Nigeria',
    'ethiopia|Ø¥Ø«ÙŠÙˆØ¨|Ã©thiop': 'Ethiopia',
    'somalia|ØµÙˆÙ…Ø§Ù„|somalie': 'Somalia',
    'kenya|ÙƒÙŠÙ†ÙŠ': 'Kenya',
    'senegal|Ø³Ù†ØºØ§Ù„|sÃ©nÃ©gal': 'Senegal',
    'lebanon|Ù„Ø¨Ù†Ø§Ù†|liban': 'Lebanon',
    'syria|Ø³ÙˆØ±ÙŠ|syrie': 'Syria',
    'iraq|Ø¹Ø±Ø§Ù‚|irak': 'Iraq',
    'islam|Ø¥Ø³Ù„Ø§Ù…': 'Islam',
    'colonial|Ø§Ø³ØªØ¹Ù…Ø§Ø±|dÃ©coloni': 'Colonialism',
    'china|ØµÙŠÙ†|chine': 'China-Africa',
    'climate|Ù…Ù†Ø§Ø®|climat': 'Climate',
    'oil|Ù†ÙØ·|pÃ©trole|energy|Ø·Ø§Ù‚Ø©': 'Energy',
    'women|Ù†Ø³Ø§Ø¡|femme|gender|Ù†ÙˆØ¹ Ø§Ø¬ØªÙ…Ø§Ø¹': 'Gender',
  };
  for (const [pattern, topic] of Object.entries(map)) {
    if (new RegExp(pattern, 'i').test(text)) topics.push(topic);
  }
  return topics.length ? topics.slice(0,4) : ['General'];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ø§Ù„Ø¬Ù„Ø¨ Ù…Ù† Google Books API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchGoogleBooks(query, langHint) {
  const books = [];
  try {
    const params = new URLSearchParams({
      q: query,
      printType: 'books',
      orderBy: 'newest',
      maxResults: '40',
    });
    const resp = await fetch(`https://www.googleapis.com/books/v1/volumes?${params}`);
    if (!resp.ok) return books;
    const data = await resp.json();
    const oneYearAgo = Date.now() - 365*24*60*60*1000;
    for (const item of (data.items||[])) {
      const v = item.volumeInfo||{};
      const pubDate = v.publishedDate||'';
      if (pubDate && new Date(pubDate).getTime() < oneYearAgo) continue;
      if (!pubDate) continue;
      const lang = v.language==='ar'?'ar': v.language==='fr'?'fr': detectLang(v.title);
      books.push({
        id: item.id,
        title: v.title + (v.subtitle ? ': '+v.subtitle : ''),
        authors: v.authors||[],
        publisher: v.publisher||'',
        publication_date: pubDate,
        pages: v.pageCount||null,
        isbn: (v.industryIdentifiers||[]).find(i=>i.type==='ISBN_13')?.identifier
              || (v.industryIdentifiers||[]).find(i=>i.type==='ISBN_10')?.identifier || '',
        book_url: v.infoLink||v.previewLink||'',
        cover: (v.imageLinks?.thumbnail||v.imageLinks?.smallThumbnail||'').replace('http:','https:'),
        description: (v.description||'').substring(0,400),
        language: lang,
        topics: detectTopics(v.title, v.description),
        categories: v.categories||[],
        source: 'Google Books',
        rating: v.averageRating||null,
        ratingsCount: v.ratingsCount||0,
      });
    }
  } catch(e) { console.warn('Google Books error:', query, e); }
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ø§Ù„Ø¬Ù„Ø¨ Ù…Ù† Open Library API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchOpenLibrary(query) {
  const books = [];
  try {
    const params = new URLSearchParams({ q: query, limit: '30', sort: 'new' });
    const resp = await fetch(`https://openlibrary.org/search.json?${params}`);
    if (!resp.ok) return books;
    const data = await resp.json();
    const oneYearAgo = new Date().getFullYear() - 1;
    for (const doc of (data.docs||[])) {
      const year = doc.first_publish_year || 0;
      if (year < oneYearAgo) continue;
      const coverId = doc.cover_i;
      books.push({
        id: 'ol_'+doc.key,
        title: doc.title||'',
        authors: doc.author_name||[],
        publisher: (doc.publisher||[])[0]||'',
        publication_date: year ? year+'-01-01' : '',
        pages: doc.number_of_pages_median||null,
        isbn: (doc.isbn||[])[0]||'',
        book_url: 'https://openlibrary.org'+doc.key,
        cover: coverId ? `https://covers.openlibrary.org/b/id/${coverId}-M.jpg` : '',
        description: '',
        language: detectLang(doc.title),
        topics: detectTopics(doc.title, (doc.subject||[]).join(' ')),
        categories: (doc.subject||[]).slice(0,3),
        source: 'Open Library',
        rating: doc.ratings_average||null,
        ratingsCount: doc.ratings_count||0,
      });
    }
  } catch(e) { console.warn('Open Library error:', query, e); }
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ø§Ù„Ø¬Ù„Ø¨ Ù…Ù† Crossref API (ÙƒØªØ¨ Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchCrossref(query) {
  const books = [];
  try {
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(oneYearAgo.getFullYear()-1);
    const from = oneYearAgo.toISOString().split('T')[0];
    const params = new URLSearchParams({
      query: query,
      filter: `type:book,from-pub-date:${from}`,
      rows: '20',
      sort: 'published',
      order: 'desc',
    });
    const resp = await fetch(`https://api.crossref.org/works?${params}`, {
      headers: { 'User-Agent': 'BooksDashboard/1.0 (mailto:dashboard@example.com)' }
    });
    if (!resp.ok) return books;
    const data = await resp.json();
    for (const item of (data.message?.items||[])) {
      const dp = item['published-print']?.['date-parts']?.[0] || item['published-online']?.['date-parts']?.[0];
      const pubDate = dp ? `${dp[0]}-${String(dp[1]||1).padStart(2,'0')}-${String(dp[2]||1).padStart(2,'0')}` : '';
      const title = (item.title||[])[0]||'';
      books.push({
        id: 'cr_'+(item.DOI||Math.random()),
        title: title,
        authors: (item.author||[]).map(a=>`${a.given||''} ${a.family||''}`.trim()),
        publisher: item.publisher||'',
        publication_date: pubDate,
        pages: item.page ? parseInt(item.page) : null,
        isbn: (item.ISBN||[])[0]||'',
        book_url: item.URL || (item.DOI ? `https://doi.org/${item.DOI}` : ''),
        cover: '',
        description: '',
        language: detectLang(title),
        topics: detectTopics(title, item.subject?.join(' ')),
        categories: item.subject||[],
        source: 'Crossref',
        rating: null,
        ratingsCount: 0,
      });
    }
  } catch(e) { console.warn('Crossref error:', query, e); }
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ø§Ù„Ø¬Ù„Ø¨ Ù…Ù† DOAB (ÙƒØªØ¨ Ù…ÙØªÙˆØ­Ø© Ø§Ù„ÙˆØµÙˆÙ„)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchDOAB(query) {
  const books = [];
  try {
    const resp = await fetch(`https://directory.doabooks.org/rest/search?query=${encodeURIComponent(query)}&expand=metadata`);
    if (!resp.ok) return books;
    const data = await resp.json();
    for (const item of (data||[]).slice(0,15)) {
      const meta = {};
      for (const m of (item.metadata||[])) {
        meta[m.key] = m.value;
      }
      books.push({
        id: 'doab_'+item.id,
        title: meta['dc.title']||item.name||'',
        authors: meta['dc.contributor.author'] ? [meta['dc.contributor.author']] : [],
        publisher: meta['publisher.name']||meta['dc.publisher']||'',
        publication_date: meta['dc.date.issued']||'',
        pages: null,
        isbn: meta['dc.identifier']||'',
        book_url: meta['dc.identifier.uri']||'',
        cover: '',
        description: (meta['dc.description.abstract']||'').substring(0,400),
        language: detectLang(meta['dc.title']||''),
        topics: detectTopics(meta['dc.title'], meta['dc.subject']),
        categories: meta['dc.subject'] ? [meta['dc.subject']] : [],
        source: 'DOAB',
        rating: null,
        ratingsCount: 0,
      });
    }
  } catch(e) { console.warn('DOAB error:', query, e); }
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateProgress(current, total, source) {
  const pct = Math.round((current/total)*100);
  document.getElementById('progressFill').style.width = pct+'%';
  document.getElementById('progressText').textContent = `â³ ${pct}% â€” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨ Ù…Ù† ${source}... (${current}/${total})`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: Ø¬Ù„Ø¨ Ù…Ù† ÙƒÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ø±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchAllBooks() {
  document.getElementById('progressBar').style.display = 'block';
  document.getElementById('refreshBtn').disabled = true;
  document.getElementById('booksGrid').innerHTML = '<div class="loader"><div class="spinner"></div><p>Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„ÙƒØªØ¨ Ù…Ù† Ø¹Ø¯Ø© Ù…Ø±Ø§ØµØ¯... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p></div>';

  const allBooks = [];
  const allQueries = [
    ...QUERIES.en.map(q => ({ q, lang:'en' })),
    ...QUERIES.fr.map(q => ({ q, lang:'fr' })),
    ...QUERIES.ar.map(q => ({ q, lang:'ar' })),
  ];

  const totalSteps = allQueries.length * 2 + 5; // Google + OpenLib + Crossref bonus
  let step = 0;

  // â”€â”€ Google Books â”€â”€
  for (const { q, lang } of allQueries) {
    step++;
    updateProgress(step, totalSteps, 'Google Books: '+q.substring(0,30));
    const books = await fetchGoogleBooks(q, lang);
    allBooks.push(...books);
    await sleep(300);
  }

  // â”€â”€ Open Library â”€â”€
  for (const { q } of allQueries) {
    step++;
    updateProgress(step, totalSteps, 'Open Library: '+q.substring(0,30));
    const books = await fetchOpenLibrary(q);
    allBooks.push(...books);
    await sleep(300);
  }

  // â”€â”€ Crossref (Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ù…Ø®ØªØ§Ø±Ø© ÙÙ‚Ø· Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¨Ø·Ø¡) â”€â”€
  const crossrefQueries = ['africa politics','arab world','sahel conflict','maghreb','middle east'];
  for (const q of crossrefQueries) {
    step++;
    updateProgress(step, totalSteps, 'Crossref: '+q);
    const books = await fetchCrossref(q);
    allBooks.push(...books);
    await sleep(800);
  }

  updateProgress(totalSteps, totalSteps, 'Ø¥Ù†Ù‡Ø§Ø¡...');

  // â”€â”€ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± â”€â”€
  const seen = new Set();
  ALL_BOOKS = allBooks.filter(b => {
    const key = (b.isbn && b.isbn.length>5) ? b.isbn : normalizeTitle(b.title)+'|||'+b.authors.join(',');
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });

  // â”€â”€ ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø£Ø­Ø¯Ø« â”€â”€
  ALL_BOOKS.sort((a,b) => new Date(b.publication_date) - new Date(a.publication_date));

  // â”€â”€ Ø­ÙØ¸ ÙÙŠ localStorage (ÙƒØ§Ø´) â”€â”€
  try {
    localStorage.setItem('books_cache', JSON.stringify({
      books: ALL_BOOKS,
      timestamp: Date.now()
    }));
  } catch(e) {}

  // â”€â”€ Ø¹Ø±Ø¶ â”€â”€
  document.getElementById('progressBar').style.display = 'none';
  document.getElementById('refreshBtn').disabled = false;
  updateStats();
  filterBooks();
  updateLastTime();
}

function normalizeTitle(t) {
  return (t||'').toLowerCase().replace(/[^\w\u0600-\u06FF]/g,'').substring(0,40);
}

function sleep(ms) { return new Promise(r=>setTimeout(r,ms)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„Ø¹Ø±Ø¶
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setLang(lang, btn) {
  currentLang = lang;
  document.querySelectorAll('.filter-btn').forEach(b => {
    b.className = 'filter-btn';
  });
  if (lang==='all') btn.classList.add('active');
  else if (lang==='ar') btn.classList.add('active-ar');
  else if (lang==='fr') btn.classList.add('active-fr');
  else if (lang==='en') btn.classList.add('active-en');
  filterBooks();
}

function filterBooks() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const topic = document.getElementById('topicSelect').value;
  const sort = document.getElementById('sortSelect').value;

  let filtered = ALL_BOOKS.filter(b => {
    if (currentLang!=='all' && b.language!==currentLang) return false;
    if (topic && !b.topics.some(t=>t.toLowerCase().includes(topic.toLowerCase()))) return false;
    if (search) {
      const hay = (b.title+' '+b.authors.join(' ')+' '+b.publisher).toLowerCase();
      if (!hay.includes(search)) return false;
    }
    return true;
  });

  // ØªØ±ØªÙŠØ¨
  if (sort==='title') filtered.sort((a,b)=>a.title.localeCompare(b.title,'ar'));
  else if (sort==='pages') filtered.sort((a,b)=>(b.pages||0)-(a.pages||0));
  else filtered.sort((a,b)=>new Date(b.publication_date)-new Date(a.publication_date));

  renderBooks(filtered);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBooks(books) {
  const grid = document.getElementById('booksGrid');

  if (!books.length) {
    grid.innerHTML = '<div class="no-results"><div class="emoji">ğŸ“š</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ù…Ø·Ø§Ø¨Ù‚Ø© â€” Ø¬Ø±Ù‘Ø¨ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„Ø§ØªØ±</p></div>';
    return;
  }

  grid.innerHTML = books.map(b => {
    const langClass = `lang-${b.language}`;
    const langLabel = b.language==='ar'?'Ø¹Ø±Ø¨ÙŠ': b.language==='fr'?'FranÃ§ais':'English';
    const date = b.publication_date ? new Date(b.publication_date).toLocaleDateString('ar-EG',{year:'numeric',month:'short',day:'numeric'}) : '';
    const coverHTML = b.cover
      ? `<img src="${b.cover}" alt="${escHtml(b.title)}" onerror="this.src='https://placehold.co/140x190/1a1a2e/ffffff?text=ğŸ“–'">`
      : `<div style="width:120px;height:170px;background:rgba(255,255,255,.08);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:3em;color:rgba(255,255,255,.3)">ğŸ“–</div>`;

    const ratingHTML = b.rating
      ? `<span>â­ ${b.rating.toFixed(1)} (${b.ratingsCount})</span>`
      : '';

    return `
    <div class="book-card">
      <div class="book-cover-wrap">
        ${coverHTML}
        <span class="lang-badge ${langClass}">${langLabel}</span>
        <span class="source-badge">${escHtml(b.source)}</span>
      </div>
      <div class="book-body" dir="rtl">
        <div class="book-title">${escHtml(b.title)}</div>
        <div class="book-author">âœï¸ ${escHtml(b.authors.slice(0,3).join('ØŒ ')||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}</div>
        <div class="book-publisher">ğŸ¢ ${escHtml(b.publisher||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}</div>
        <div class="book-meta">
          ${date ? `<span>ğŸ“… ${date}</span>` : ''}
          ${b.pages ? `<span>ğŸ“„ ${b.pages} ØµÙØ­Ø©</span>` : ''}
          ${b.isbn ? `<span>ğŸ“‹ ${b.isbn}</span>` : ''}
          ${ratingHTML}
        </div>
        <div class="book-topics">
          ${b.topics.slice(0,4).map(t=>`<span class="topic-tag">${escHtml(t)}</span>`).join('')}
        </div>
        ${b.description ? `<div class="book-desc">${escHtml(b.description)}</div>` : ''}
        <div class="book-actions">
          <a href="${escHtml(b.book_url)}" target="_blank" rel="noopener" class="btn-link btn-primary">ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„ÙƒØªØ§Ø¨</a>
          ${b.isbn ? `<a href="https://www.worldcat.org/isbn/${b.isbn}" target="_blank" rel="noopener" class="btn-link btn-secondary">ğŸ“š WorldCat</a>` : ''}
        </div>
      </div>
    </div>`;
  }).join('');
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s||'';
  return d.innerHTML;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats() {
  document.getElementById('totalCount').textContent = ALL_BOOKS.length;
  document.getElementById('arCount').textContent = ALL_BOOKS.filter(b=>b.language==='ar').length;
  document.getElementById('frCount').textContent = ALL_BOOKS.filter(b=>b.language==='fr').length;
  document.getElementById('enCount').textContent = ALL_BOOKS.filter(b=>b.language==='en').length;
  document.getElementById('sourceCount').textContent = SOURCES_LIST.length;
  const pubs = new Set(ALL_BOOKS.map(b=>b.publisher).filter(Boolean));
  document.getElementById('pubCount').textContent = pubs.size;
}

function updateLastTime() {
  document.getElementById('lastUpdate').textContent = 'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' +
    new Date().toLocaleString('ar-EG', { dateStyle:'medium', timeStyle:'short' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§ØµØ¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSources() {
  const el = document.getElementById('sourcesList');
  el.classList.toggle('open');
  if (el.classList.contains('open') && !el.innerHTML) {
    el.innerHTML = SOURCES_LIST.map((s,i) => `${i+1}. ${s}`).join('<br>');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙŠØ¯ÙˆÙŠ + Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function manualRefresh() {
  localStorage.removeItem('books_cache');
  fetchAllBooks();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function init() {
  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒØ§Ø´ (ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø© Ø³Ø§Ø¹Ø©)
  try {
    const cache = JSON.parse(localStorage.getItem('books_cache'));
    if (cache && (Date.now() - cache.timestamp) < 3600000) {
      ALL_BOOKS = cache.books;
      updateStats();
      filterBooks();
      updateLastTime();
      console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ÙƒØ§Ø´:', ALL_BOOKS.length, 'ÙƒØªØ§Ø¨');

      // Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ù„ÙŠ
      const remaining = 3600000 - (Date.now() - cache.timestamp);
      setTimeout(() => fetchAllBooks(), remaining);
      return;
    }
  } catch(e) {}

  // Ø¬Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
  await fetchAllBooks();
})();

// â”€â”€ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ Ø³Ø§Ø¹Ø© â”€â”€
setInterval(() => {
  console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ...');
  fetchAllBooks();
}, 3600000);
</script>

</body>
</html>
