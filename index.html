<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø±ØµØ¯ ÙƒØªØ¨ Ø§Ù„Ø´Ø£Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ | Africa Books Observatory ğŸŒ</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#f5f5f5;--card:#fff;--text:#1a1a1a;--text2:#666;
--gold:#D4A017;--green:#009639;--black:#000;
--ar:#009639;--fr:#2563eb;--en:#7c3aed;
--shadow:0 2px 24px rgba(0,0,0,.08);--radius:18px
}
body{font-family:'Segoe UI','Cairo',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.65;min-height:100vh}
.hero{background:linear-gradient(135deg,#1B5E20 0%,#D4A017 50%,#E65100 100%);color:#fff;padding:50px 20px;text-align:center;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;inset:0;background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' fill='white' opacity='0.03'%3EğŸŒ%3C/text%3E%3C/svg%3E");background-size:80px;pointer-events:none}
.hero h1{font-size:2.5em;font-weight:900;margin-bottom:12px;text-shadow:2px 2px 8px rgba(0,0,0,.3);position:relative;z-index:2}
.hero .sub{font-size:1.2em;opacity:.95;margin-bottom:20px;font-weight:500;position:relative;z-index:2}
.hero .info{font-size:.95em;opacity:.9;max-width:900px;margin:0 auto;line-height:1.8;position:relative;z-index:2}
.stats-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;max-width:1400px;margin:-35px auto 30px;padding:0 20px;position:relative;z-index:10}
.stat-card{background:var(--card);border-radius:var(--radius);padding:20px 14px;text-align:center;box-shadow:var(--shadow);border-top:4px solid var(--green);transition:transform .3s}
.stat-card:hover{transform:translateY(-4px)}
.stat-card .icon{font-size:1.8em;margin-bottom:4px}
.stat-card .num{font-size:1.8em;font-weight:900;color:var(--green);line-height:1}
.stat-card .lbl{font-size:.8em;color:var(--text2);margin-top:4px;font-weight:600}
.controls{max-width:1400px;margin:0 auto 28px;padding:0 20px}
.search-row{display:flex;gap:12px;margin-bottom:14px;flex-wrap:wrap}
.search-box{flex:1;min-width:280px;padding:14px 24px;border-radius:50px;border:2px solid #e0e0e0;font-size:1.05em;outline:none;transition:all .3s;background:#fff;direction:rtl}
.search-box:focus{border-color:var(--green);box-shadow:0 0 0 4px rgba(0,150,57,.1)}
.filter-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.filter-label{font-size:.9em;font-weight:700;color:var(--text);margin-left:6px}
.fbtn{padding:9px 20px;border-radius:50px;border:2px solid #e0e0e0;background:#fff;cursor:pointer;font-size:.9em;font-weight:700;transition:all .3s;color:var(--text)}
.fbtn:hover{border-color:var(--green);color:var(--green)}
.fbtn.active{background:var(--green);color:#fff;border-color:var(--green)}
.fbtn.a-ar{background:var(--ar);color:#fff;border-color:var(--ar)}
.fbtn.a-fr{background:var(--fr);color:#fff;border-color:var(--fr)}
.fbtn.a-en{background:var(--en);color:#fff;border-color:var(--en)}
.sel{padding:9px 18px;border-radius:50px;border:2px solid #e0e0e0;background:#fff;font-size:.9em;font-weight:600;cursor:pointer;outline:none}
.sel:focus{border-color:var(--green)}
.update-bar{max-width:1400px;margin:0 auto 20px;padding:0 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
.live{display:flex;align-items:center;gap:8px;font-size:.9em;color:var(--green);font-weight:700}
.live-dot{width:10px;height:10px;background:var(--green);border-radius:50%;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.85)}}
.time{font-size:.85em;color:var(--text2)}
.rbtn{padding:10px 24px;border-radius:50px;border:none;background:var(--green);color:#fff;cursor:pointer;font-size:.9em;font-weight:700;transition:all .3s;box-shadow:0 2px 8px rgba(0,150,57,.2)}
.rbtn:hover{background:#007a2e}
.rbtn:disabled{opacity:.5;cursor:not-allowed}
.src-stats{max-width:1400px;margin:0 auto 16px;padding:0 20px}
.src-grid{display:flex;flex-wrap:wrap;gap:8px}
.src-tag{padding:6px 14px;border-radius:30px;font-size:.78em;font-weight:700;background:#f0f9f4;color:var(--green);border:1px solid #d1f0dd;display:flex;align-items:center;gap:5px}
.src-tag .dot{width:7px;height:7px;border-radius:50%}
.src-tag .dot.on{background:var(--green)}.src-tag .dot.off{background:#ccc}
.pbar{max-width:1400px;margin:0 auto 16px;padding:0 20px;display:none}
.ptrack{height:6px;background:#e0e0e0;border-radius:6px;overflow:hidden}
.pfill{height:100%;background:linear-gradient(90deg,var(--green),var(--gold));border-radius:6px;transition:width .5s;width:0}
.ptxt{font-size:.8em;color:var(--text2);margin-top:6px;text-align:center;font-weight:600}
.books-grid{max-width:1400px;margin:0 auto;padding:0 20px 50px;display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:24px}
.book-card{background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);border-top:4px solid var(--green);transition:transform .3s,box-shadow .3s;display:flex;flex-direction:column}
.book-card:hover{transform:translateY(-6px);box-shadow:0 12px 40px rgba(0,0,0,.15)}
.cover-wrap{position:relative;height:240px;background:linear-gradient(135deg,#1a1a1a,#2c2c2c);display:flex;align-items:center;justify-content:center;overflow:hidden}
.cover-wrap img{height:200px;max-width:150px;object-fit:cover;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.5);transition:transform .4s;position:relative;z-index:2}
.book-card:hover .cover-wrap img{transform:scale(1.05)}
.lang-badge{position:absolute;top:14px;right:14px;padding:6px 16px;border-radius:30px;font-size:.8em;font-weight:800;color:#fff;z-index:3;box-shadow:0 2px 8px rgba(0,0,0,.3)}
.l-ar{background:var(--ar)}.l-fr{background:var(--fr)}.l-en{background:var(--en)}
.src-badge{position:absolute;bottom:12px;left:12px;padding:4px 12px;border-radius:12px;font-size:.7em;background:rgba(255,255,255,.2);color:rgba(255,255,255,.9);backdrop-filter:blur(6px);font-weight:700;z-index:3}
.book-body{padding:20px;flex:1;display:flex;flex-direction:column}
.book-title{font-size:1.1em;font-weight:800;line-height:1.5;color:var(--text);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;margin-bottom:10px}
.book-author{font-size:.95em;color:var(--green);font-weight:700;margin-bottom:6px}
.book-pub{font-size:.85em;color:var(--text2);margin-bottom:10px}
.book-meta{display:flex;flex-wrap:wrap;gap:12px;font-size:.8em;color:var(--text2);margin-bottom:12px}
.book-meta span{display:flex;align-items:center;gap:4px;font-weight:600}
.topics{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px}
.tag{padding:4px 14px;border-radius:30px;font-size:.75em;background:#f0f9f4;color:var(--green);font-weight:700;border:1px solid #d1f0dd}
.tag.hot{background:#fff3e0;color:#E65100;border-color:#ffe0b2}
.book-desc{font-size:.88em;color:var(--text2);line-height:1.65;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;margin-bottom:14px}
.book-actions{margin-top:auto;display:flex;gap:10px;flex-wrap:wrap}
.blink{flex:1;min-width:100px;padding:11px;text-align:center;border-radius:14px;font-size:.85em;font-weight:700;text-decoration:none;transition:all .3s}
.bp{background:var(--black);color:#fff}.bp:hover{background:var(--green);transform:translateY(-2px)}
.bs{background:#f5f5f5;color:var(--text);border:2px solid #e0e0e0}.bs:hover{background:#eee;border-color:var(--green)}
.loader{text-align:center;padding:80px;grid-column:1/-1}
.spinner{width:60px;height:60px;border:5px solid #e0e0e0;border-top-color:var(--green);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
@keyframes spin{to{transform:rotate(360deg)}}
.loader p{font-size:1.1em;color:var(--text2);font-weight:600}
.no-res{text-align:center;padding:80px;grid-column:1/-1;color:var(--text2)}
.no-res .emoji{font-size:5em;margin-bottom:16px}
.notif{position:fixed;bottom:20px;right:20px;background:var(--green);color:#fff;padding:16px 24px;border-radius:14px;font-weight:700;font-size:.95em;box-shadow:0 8px 32px rgba(0,0,0,.3);z-index:1000;display:none;animation:slideUp .5s ease-out}
@keyframes slideUp{from{transform:translateY(100px);opacity:0}to{transform:translateY(0);opacity:1}}
footer{background:linear-gradient(135deg,#1B5E20,#2c2c2c);color:#fff;text-align:center;padding:40px 20px;margin-top:40px}
footer h3{font-size:1.4em;margin-bottom:12px;font-weight:800}
footer p{font-size:.9em;opacity:.85;margin-bottom:6px;line-height:1.8}
@media(max-width:768px){.hero h1{font-size:1.7em}.books-grid{grid-template-columns:1fr}.stats-bar{grid-template-columns:repeat(3,1fr)}.filter-row{justify-content:center}}
</style>
</head>
<body>

<div class="hero">
<h1>ğŸŒ Ù…Ø±ØµØ¯ ÙƒØªØ¨ Ø§Ù„Ø´Ø£Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ</h1>
<p class="sub">Africa Books Observatory | Observatoire des livres sur l'Afrique</p>
<p class="info">
Ù…Ø±ØµØ¯ Ø¢Ù„ÙŠ ÙŠØ¬Ù…Ø¹ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø© Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± 12 Ø´Ù‡Ø±Ø§Ù‹ Ø­ÙˆÙ„ Ø§Ù„Ø´Ø£Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ Ù…Ù† <strong>16 Ù…ØµØ¯Ø±Ø§Ù‹</strong> Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ§Ù‹ ÙˆØ±Ù‚Ù…ÙŠØ§Ù‹ Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
<br>Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ§Ù„ÙØ±Ù†Ø³ÙŠØ©
</p>
</div>

<div class="stats-bar">
<div class="stat-card"><div class="icon">ğŸ“š</div><div class="num" id="sTotal">-</div><div class="lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØªØ¨</div></div>
<div class="stat-card"><div class="icon">ğŸ‡¸ğŸ‡¦</div><div class="num" id="sAr">-</div><div class="lbl">Ø¹Ø±Ø¨ÙŠ</div></div>
<div class="stat-card"><div class="icon">ğŸ‡¬ğŸ‡§</div><div class="num" id="sEn">-</div><div class="lbl">English</div></div>
<div class="stat-card"><div class="icon">ğŸ‡«ğŸ‡·</div><div class="num" id="sFr">-</div><div class="lbl">FranÃ§ais</div></div>
<div class="stat-card"><div class="icon">ğŸ›</div><div class="num" id="sPub">-</div><div class="lbl">Ù†Ø§Ø´Ø±</div></div>
<div class="stat-card"><div class="icon">ğŸ”Œ</div><div class="num" id="sSrc">-</div><div class="lbl">Ù…ØµØ¯Ø± ÙØ¹Ù‘Ø§Ù„</div></div>
</div>

<div class="controls">
<div class="search-row">
<input type="text" class="search-box" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒØªØ§Ø¨ Ø£Ùˆ Ù…Ø¤Ù„Ù Ø£Ùˆ Ù†Ø§Ø´Ø±..." oninput="filterBooks()">
</div>
<div class="filter-row">
<span class="filter-label">Ø§Ù„Ù„ØºØ©:</span>
<button class="fbtn active" onclick="setLang('all',this)">Ø§Ù„ÙƒÙ„</button>
<button class="fbtn" onclick="setLang('ar',this)">Ø¹Ø±Ø¨ÙŠ</button>
<button class="fbtn" onclick="setLang('en',this)">English</button>
<button class="fbtn" onclick="setLang('fr',this)">FranÃ§ais</button>

<span class="filter-label" style="margin-right:18px">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:</span>
<select class="sel" id="topicSel" onchange="filterBooks()">
<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹</option>
<option value="Politics">Ø§Ù„Ø³ÙŠØ§Ø³Ø©</option>
<option value="History">Ø§Ù„ØªØ§Ø±ÙŠØ®</option>
<option value="Economy">Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯</option>
<option value="Development">Ø§Ù„ØªÙ†Ù…ÙŠØ©</option>
<option value="Conflict">Ø§Ù„Ù†Ø²Ø§Ø¹Ø§Øª</option>
<option value="Sahel">Ø§Ù„Ø³Ø§Ø­Ù„</option>
<option value="Horn of Africa">Ø§Ù„Ù‚Ø±Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ</option>
<option value="North Africa">Ø´Ù…Ø§Ù„ Ø£ÙØ±ÙŠÙ‚ÙŠØ§</option>
<option value="West Africa">ØºØ±Ø¨ Ø£ÙØ±ÙŠÙ‚ÙŠØ§</option>
<option value="East Africa">Ø´Ø±Ù‚ Ø£ÙØ±ÙŠÙ‚ÙŠØ§</option>
<option value="Southern Africa">Ø§Ù„Ø¬Ù†ÙˆØ¨ Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ</option>
<option value="Central Africa">ÙˆØ³Ø· Ø£ÙØ±ÙŠÙ‚ÙŠØ§</option>
<option value="Migration">Ø§Ù„Ù‡Ø¬Ø±Ø©</option>
<option value="Security">Ø§Ù„Ø£Ù…Ù†</option>
<option value="Culture">Ø§Ù„Ø«Ù‚Ø§ÙØ©</option>
<option value="Literature">Ø§Ù„Ø£Ø¯Ø¨</option>
<option value="Health">Ø§Ù„ØµØ­Ø©</option>
<option value="Environment">Ø§Ù„Ø¨ÙŠØ¦Ø©</option>
<option value="Governance">Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</option>
<option value="Pan-Africanism">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©</option>
<option value="Terrorism">Ø§Ù„Ø¥Ø±Ù‡Ø§Ø¨</option>
<option value="Democracy">Ø§Ù„Ø¯ÙŠÙ…Ù‚Ø±Ø§Ø·ÙŠØ©</option>
<option value="Colonialism">Ø§Ù„Ø§Ø³ØªØ¹Ù…Ø§Ø±</option>
<option value="Trade">Ø§Ù„ØªØ¬Ø§Ø±Ø©</option>
<option value="Education">Ø§Ù„ØªØ¹Ù„ÙŠÙ…</option>
<option value="Agriculture">Ø§Ù„Ø²Ø±Ø§Ø¹Ø©</option>
<option value="Mining">Ø§Ù„ØªØ¹Ø¯ÙŠÙ†</option>
<option value="Women">Ø§Ù„Ù…Ø±Ø£Ø©</option>
<option value="Youth">Ø§Ù„Ø´Ø¨Ø§Ø¨</option>
<option value="Refugees">Ø§Ù„Ù„Ø§Ø¬Ø¦ÙˆÙ†</option>
</select>

<span class="filter-label" style="margin-right:18px">Ø§Ù„Ù…ØµØ¯Ø±:</span>
<select class="sel" id="srcSel" onchange="filterBooks()">
<option value="">ÙƒÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ø±</option>
</select>

<span class="filter-label" style="margin-right:18px">Ø§Ù„ØªØ±ØªÙŠØ¨:</span>
<select class="sel" id="sortSel" onchange="filterBooks()">
<option value="newest">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
<option value="oldest">Ø§Ù„Ø£Ù‚Ø¯Ù…</option>
<option value="rating">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</option>
<option value="title">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</option>
</select>
</div>
</div>

<div class="update-bar">
<div class="live"><span class="live-dot"></span><span>Ù…Ø³Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø³ØªÙ…Ø±</span></div>
<span class="time" id="lastUp">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
<button class="rbtn" id="rBtn" onclick="manualRefresh()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø´Ø§Ù…Ù„</button>
</div>

<div class="src-stats" id="srcStats"></div>

<div class="pbar" id="pbar">
<div class="ptrack"><div class="pfill" id="pfill"></div></div>
<div class="ptxt" id="ptxt">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>
</div>

<div class="books-grid" id="grid">
<div class="loader"><div class="spinner"></div><p>Ø¬Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ¨...</p></div>
</div>

<div class="notif" id="notif"></div>

<footer>
<h3>ğŸŒ Ù…Ø±ØµØ¯ ÙƒØªØ¨ Ø§Ù„Ø´Ø£Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ</h3>
<p>Africa Books Observatory | Observatoire des livres sur l'Afrique</p>
<p>16 Ù…ØµØ¯Ø±Ø§Ù‹: Google Books â€¢ Open Library â€¢ Crossref â€¢ OpenAlex â€¢ Semantic Scholar â€¢ DOAB â€¢ OAPEN â€¢ Internet Archive â€¢ LOC â€¢ BnF â€¢ ISIDORE â€¢ BASE â€¢ CORE â€¢ Europeana â€¢ WorldCat â€¢ DBLP</p>
<p style="font-size:.85em;margin-top:10px">2025 Â© Africa Books Observatory</p>
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ù…Ø±ØµØ¯ ÙƒØªØ¨ Ø§Ù„Ø´Ø£Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ - 16 Ù…ØµØ¯Ø±Ø§Ù‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let ALL_BOOKS=[];
let currentLang='all';
let isUpdating=false;
let activeSources=new Map();
const DAILY_MS=24*60*60*1000;
const CACHE_KEY='abooks_v2';

function getMinDate(){const d=new Date();d.setMonth(d.getMonth()-12);return d}
function getMinDateStr(){const d=getMinDate();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}
function isWithin12Months(ds){if(!ds)return false;try{const d=new Date(ds);if(isNaN(d.getTime()))return false;return d>=getMinDate()}catch(e){return false}}
function fmtDate(ds){if(!ds)return'';try{const d=new Date(ds);if(isNaN(d.getTime()))return'';return['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][d.getMonth()]+' '+d.getFullYear()}catch(e){return''}}
function fmtDateTime(){const d=new Date();return d.getDate()+' '+['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][d.getMonth()]+' '+d.getFullYear()+', '+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')}
function sleep(ms){return new Promise(r=>setTimeout(r,ms))}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function showNotif(msg){const el=document.getElementById('notif');el.textContent=msg;el.style.display='block';setTimeout(()=>el.style.display='none',5000)}

// â•â•â•â•â•â•â•â•â•â• ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© Ø£ÙØ±ÙŠÙ‚ÙŠØ© â•â•â•â•â•â•â•â•â•â•
const AFK=[
'africa','african','africans','sub-saharan','subsaharan',
'west africa','east africa','north africa','southern africa','central africa',
'sahel','saharan','maghreb','african union','pan-african','pan-africanism',
'nigeria','nigerian','ethiopia','ethiopian','kenya','kenyan',
'south africa','south african','ghana','ghanaian','tanzania','tanzanian',
'uganda','ugandan','senegal','senegalese','cameroon','cameroonian',
'ivory coast','cote d\'ivoire','mozambique','mozambican','madagascar',
'angola','angolan','mali','malian','niger','nigerien',
'burkina faso','burkinabe','chad','chadian','sudan','sudanese','south sudan',
'somalia','somali','somaliland','eritrea','eritrean','djibouti',
'rwanda','rwandan','burundi','burundian','congo','congolese','drc',
'zimbabwe','zimbabwean','zambia','zambian','malawi','malawian',
'botswana','namibia','namibian','lesotho','eswatini',
'morocco','moroccan','algeria','algerian','tunisia','tunisian',
'libya','libyan','egypt','egyptian','mauritania','mauritanian',
'sierra leone','liberia','liberian','guinea','guinean','gambia','gambian',
'cape verde','togo','togolese','benin','beninese','gabon','gabonese',
'equatorial guinea','sao tome','comoros','seychelles',
'horn of africa','great lakes africa','lake chad',
'western sahara','sahrawi','addis ababa','nairobi','lagos','johannesburg',
'cairo','casablanca','accra','dakar','abuja','pretoria','khartoum',
'mogadishu','kinshasa','luanda','maputo','dar es salaam','kampala',
'ecowas','sadc','igad','comesa','eac','cemac','nepad','afdb','afcfta',
'boko haram','al-shabaab','african diaspora','african governance',
'african democracy','african development','african migration',
'apartheid','mandela',

'afrique','africain','africaine','afrique de l\'ouest','afrique de l\'est',
'afrique du nord','afrique australe','afrique centrale','afrique subsaharienne',
'union africaine','panafricain','panafricanisme','cedeao','franc cfa',
'sahel','sahelien','migration africaine','gouvernance africaine',

'Ø£ÙØ±ÙŠÙ‚ÙŠØ§','Ø£ÙØ±ÙŠÙ‚ÙŠ','Ø£ÙØ±ÙŠÙ‚ÙŠØ©','Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ','Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©',
'Ø§ÙØ±ÙŠÙ‚ÙŠØ§','Ø§ÙØ±ÙŠÙ‚ÙŠ','Ø§ÙØ±ÙŠÙ‚ÙŠØ©','Ø§Ù„Ø§ÙØ±ÙŠÙ‚ÙŠ','Ø§Ù„Ø§ÙØ±ÙŠÙ‚ÙŠØ©',
'ØºØ±Ø¨ Ø£ÙØ±ÙŠÙ‚ÙŠØ§','Ø´Ø±Ù‚ Ø£ÙØ±ÙŠÙ‚ÙŠØ§','Ø´Ù…Ø§Ù„ Ø£ÙØ±ÙŠÙ‚ÙŠØ§','Ø¬Ù†ÙˆØ¨ Ø£ÙØ±ÙŠÙ‚ÙŠØ§','ÙˆØ³Ø· Ø£ÙØ±ÙŠÙ‚ÙŠØ§',
'Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ','Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø§ÙØ±ÙŠÙ‚ÙŠ','Ø§Ù„Ù‚Ø§Ø±Ø© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©','Ø§Ù„Ù‚Ø§Ø±Ø© Ø§Ù„Ø³Ù…Ø±Ø§Ø¡',
'Ø§Ù„Ø³Ø§Ø­Ù„ Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ','Ø§Ù„Ù‚Ø±Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ','Ø§Ù„Ù…ØºØ±Ø¨ Ø§Ù„Ø¹Ø±Ø¨ÙŠ',
'Ù†ÙŠØ¬ÙŠØ±ÙŠØ§','Ø¥Ø«ÙŠÙˆØ¨ÙŠØ§','ÙƒÙŠÙ†ÙŠØ§','ØºØ§Ù†Ø§','ØªÙ†Ø²Ø§Ù†ÙŠØ§','Ø£ÙˆØºÙ†Ø¯Ø§','Ø§Ù„Ø³Ù†ØºØ§Ù„','Ø§Ù„ÙƒØ§Ù…ÙŠØ±ÙˆÙ†',
'Ø³Ø§Ø­Ù„ Ø§Ù„Ø¹Ø§Ø¬','Ù…Ø§Ù„ÙŠ','Ø§Ù„Ù†ÙŠØ¬Ø±','Ø¨ÙˆØ±ÙƒÙŠÙ†Ø§ ÙØ§Ø³Ùˆ','ØªØ´Ø§Ø¯','Ø§Ù„Ø³ÙˆØ¯Ø§Ù†','Ø¬Ù†ÙˆØ¨ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†',
'Ø§Ù„ØµÙˆÙ…Ø§Ù„','Ø¥Ø±ÙŠØªØ±ÙŠØ§','Ø¬ÙŠØ¨ÙˆØªÙŠ','Ø±ÙˆØ§Ù†Ø¯Ø§','Ø¨ÙˆØ±ÙˆÙ†Ø¯ÙŠ','Ø§Ù„ÙƒÙˆÙ†ØºÙˆ',
'Ø§Ù„Ù…ØºØ±Ø¨','Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±','ØªÙˆÙ†Ø³','Ù„ÙŠØ¨ÙŠØ§','Ù…ÙˆØ±ÙŠØªØ§Ù†ÙŠØ§',
'Ø¨ÙˆÙƒÙˆ Ø­Ø±Ø§Ù…','Ø­Ø±ÙƒØ© Ø§Ù„Ø´Ø¨Ø§Ø¨','Ø¥ÙŠÙƒÙˆØ§Ø³','Ø§Ù„Ù‡Ø¬Ø±Ø© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©','Ø§Ù„ØªÙ†Ù…ÙŠØ© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©',
'Ù…Ø§Ù†Ø¯ÙŠÙ„Ø§'
];

function isAfricaBook(title,desc,authors){
  const t=((title||'')+'').toLowerCase();
  const d=((desc||'')+'').toLowerCase();
  const a=((authors||[]).join(' ')).toLowerCase();
  const all=t+' '+d;
  for(const kw of AFK)if(t.includes(kw))return true;
  let hits=0;
  for(const kw of AFK)if(d.includes(kw)){hits++;if(hits>=2)return true}
  return false;
}

function detectLang(text){
  if(!text)return'en';
  if(/[\u0600-\u06FF]/.test(text))return'ar';
  if(/[Ã Ã¢Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã¿Ã§Å“Ã¦]/i.test(text)||/\b(le|la|les|du|des|une?|et|dans|pour|avec|sur|par|livre|histoire|politique|afrique)\b/i.test(text))return'fr';
  return'en';
}

function detectTopics(title,desc){
  const t=((title||'')+' '+(desc||'')).toLowerCase();
  const out=[];
  const map=[
    [/politi|Ø³ÙŠØ§Ø³/i,'Politics'],[/histor|histoire|ØªØ§Ø±ÙŠØ®/i,'History'],
    [/econom|Ã©conomi|Ø§Ù‚ØªØµØ§Ø¯/i,'Economy'],[/develop|dÃ©velopp|ØªÙ†Ù…ÙŠ/i,'Development'],
    [/conflict|conflit|guerre|war|Ø­Ø±Ø¨|Ù†Ø²Ø§Ø¹/i,'Conflict'],
    [/sahel|Ø³Ø§Ø­Ù„/i,'Sahel'],[/horn.of.africa|corne|Ù‚Ø±Ù†.Ø£ÙØ±ÙŠÙ‚/i,'Horn of Africa'],
    [/north.africa|afrique.du.nord|Ø´Ù…Ø§Ù„.Ø£ÙØ±ÙŠÙ‚|Ù…ØºØ±Ø¨/i,'North Africa'],
    [/west.africa|afrique.de.l.ouest|ØºØ±Ø¨.Ø£ÙØ±ÙŠÙ‚/i,'West Africa'],
    [/east.africa|afrique.de.l.est|Ø´Ø±Ù‚.Ø£ÙØ±ÙŠÙ‚/i,'East Africa'],
    [/southern.africa|afrique.australe|Ø¬Ù†ÙˆØ¨.Ø£ÙØ±ÙŠÙ‚/i,'Southern Africa'],
    [/central.africa|afrique.centrale|ÙˆØ³Ø·.Ø£ÙØ±ÙŠÙ‚/i,'Central Africa'],
    [/migrat|Ù‡Ø¬Ø±/i,'Migration'],[/security|sÃ©curitÃ©|Ø£Ù…Ù†/i,'Security'],
    [/cultur|Ø«Ù‚Ø§Ù/i,'Culture'],[/literature|littÃ©rature|Ø£Ø¯Ø¨/i,'Literature'],
    [/health|santÃ©|ØµØ­/i,'Health'],[/environment|environnement|Ø¨ÙŠØ¦/i,'Environment'],
    [/governance|gouvernance|Ø­ÙˆÙƒÙ…/i,'Governance'],
    [/pan.african|panafricain|ÙˆØ­Ø¯Ø©.Ø£ÙØ±ÙŠÙ‚/i,'Pan-Africanism'],
    [/terror|Ø¥Ø±Ù‡Ø§Ø¨/i,'Terrorism'],[/democracy|dÃ©mocratie|Ø¯ÙŠÙ…Ù‚Ø±Ø§Ø·/i,'Democracy'],
    [/colon|Ø§Ø³ØªØ¹Ù…Ø§Ø±/i,'Colonialism'],[/trade|commerce|ØªØ¬Ø§Ø±/i,'Trade'],
    [/education|Ã©ducation|ØªØ¹Ù„ÙŠÙ…/i,'Education'],[/agricul|Ø²Ø±Ø§Ø¹/i,'Agriculture'],
    [/mining|minerai|ØªØ¹Ø¯ÙŠÙ†/i,'Mining'],[/women|femmes|Ù…Ø±Ø£Ø©|Ù†Ø³Ø§Ø¡/i,'Women'],
    [/youth|jeunesse|Ø´Ø¨Ø§Ø¨/i,'Youth'],[/refugee|rÃ©fugiÃ©|Ù„Ø§Ø¬Ø¦/i,'Refugees'],
    [/oil|pÃ©trole|Ù†ÙØ·/i,'Oil & Resources'],[/coup|Ø§Ù†Ù‚Ù„Ø§Ø¨/i,'Coups']
  ];
  for(const[rx,label]of map)if(rx.test(t))out.push(label);
  if(!out.length)out.push('Africa');
  return out.slice(0,5);
}

function normT(s){return(s||'').toLowerCase().replace(/[^\w\s\u0600-\u06FF]/g,' ').replace(/\s+/g,' ').trim().substring(0,80)}
function dedup(books){
  const seen=new Set(),titles=[],out=[];
  for(const b of books){
    const nt=normT(b.title);if(!nt||nt.length<5)continue;
    const isbn=(b.isbn||'').replace(/[^0-9X]/gi,'');
    if(isbn.length>=10){if(seen.has('i:'+isbn))continue;seen.add('i:'+isbn)}
    let dup=false;
    for(const et of titles){
      if(nt===et||nt.includes(et)||et.includes(nt)){dup=true;break}
      const w1=new Set(nt.split(' ').filter(w=>w.length>2));
      const w2=new Set(et.split(' ').filter(w=>w.length>2));
      if(w1.size&&w2.size){const inter=[...w1].filter(x=>w2.has(x)).length;if(inter/new Set([...w1,...w2]).size>.7){dup=true;break}}
    }
    if(dup)continue;titles.push(nt);out.push(b);
  }
  return out;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Q={
en:[
"africa 2024","africa 2025","african politics","african history","african economy",
"african development","sub-saharan africa","west africa","east africa","north africa",
"southern africa","central africa","sahel crisis","sahel security","horn of africa",
"african union","pan-africanism","african governance","african democracy",
"african conflict","african migration","african diaspora","african literature",
"african culture","nigeria 2024","ethiopia 2024","kenya 2024","south africa 2024",
"ghana 2024","senegal 2024","congo 2024","sudan crisis","south sudan","somalia 2024",
"cameroon 2024","mali 2024","niger 2024","burkina faso","chad 2024",
"boko haram","al-shabaab","ECOWAS","SADC","IGAD","AfCFTA",
"african climate","african health","african education","african agriculture",
"decolonization africa","colonialism africa","postcolonial africa",
"apartheid","mandela","african coup","african mining","african oil",
"african refugees","african women","african youth",
"rwanda genocide","darfur","tigray","libyan crisis"
],
fr:[
"afrique 2024","afrique 2025","politique africaine","histoire africaine",
"Ã©conomie africaine","dÃ©veloppement africain","afrique subsaharienne",
"afrique de l'ouest","afrique de l'est","afrique du nord",
"afrique australe","afrique centrale","sahel crise","sahel sÃ©curitÃ©",
"corne afrique","union africaine","panafricanisme","gouvernance africaine",
"dÃ©mocratie africaine","conflit africain","migration africaine",
"diaspora africaine","littÃ©rature africaine","culture africaine",
"nigeria 2024","sÃ©nÃ©gal 2024","cameroun 2024","congo 2024",
"soudan crise","somalie 2024","mali 2024","niger 2024","burkina faso 2024",
"tchad 2024","boko haram","CEDEAO","franc CFA","ZLECA",
"changement climatique afrique","santÃ© afrique","Ã©ducation afrique",
"agriculture afrique","dÃ©colonisation afrique","colonialisme afrique",
"postcolonial afrique","apartheid","mandela",
"coup d'Ã©tat afrique","ressources naturelles afrique",
"rÃ©fugiÃ©s africains","femmes africaines","jeunesse africaine",
"alain mabanckou","achille mbembe","felwine sarr","cheikh anta diop",
"karthala afrique","harmattan afrique","prÃ©sence africaine"
],
ar:[
"Ø£ÙØ±ÙŠÙ‚ÙŠØ§ 2024","Ø£ÙØ±ÙŠÙ‚ÙŠØ§ 2025","Ø§Ù„Ø´Ø£Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ","Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©",
"Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ","Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ","Ø§Ù„ØªÙ†Ù…ÙŠØ© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©",
"Ø§Ù„Ù‚Ø§Ø±Ø© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©","ØºØ±Ø¨ Ø£ÙØ±ÙŠÙ‚ÙŠØ§","Ø´Ø±Ù‚ Ø£ÙØ±ÙŠÙ‚ÙŠØ§","Ø´Ù…Ø§Ù„ Ø£ÙØ±ÙŠÙ‚ÙŠØ§",
"Ø¬Ù†ÙˆØ¨ Ø£ÙØ±ÙŠÙ‚ÙŠØ§","ÙˆØ³Ø· Ø£ÙØ±ÙŠÙ‚ÙŠØ§","Ø§Ù„Ø³Ø§Ø­Ù„ Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ","Ø§Ù„Ù‚Ø±Ù† Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ",
"Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ","Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©","Ø§Ù„Ø­ÙˆÙƒÙ…Ø© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©",
"Ø§Ù„Ù†Ø²Ø§Ø¹Ø§Øª Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©","Ø§Ù„Ù‡Ø¬Ø±Ø© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©","Ø§Ù„Ø£Ø¯Ø¨ Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ",
"Ø§Ù„Ø«Ù‚Ø§ÙØ© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©","Ù†ÙŠØ¬ÙŠØ±ÙŠØ§","Ø¥Ø«ÙŠÙˆØ¨ÙŠØ§","ÙƒÙŠÙ†ÙŠØ§","Ø§Ù„Ø³Ù†ØºØ§Ù„",
"Ø§Ù„ÙƒØ§Ù…ÙŠØ±ÙˆÙ†","Ø§Ù„ÙƒÙˆÙ†ØºÙˆ","Ø§Ù„Ø³ÙˆØ¯Ø§Ù†","Ø§Ù„ØµÙˆÙ…Ø§Ù„","Ù…Ø§Ù„ÙŠ","Ø§Ù„Ù†ÙŠØ¬Ø±",
"Ø¨ÙˆØ±ÙƒÙŠÙ†Ø§ ÙØ§Ø³Ùˆ","ØªØ´Ø§Ø¯","Ø¨ÙˆÙƒÙˆ Ø­Ø±Ø§Ù…","Ø¥ÙŠÙƒÙˆØ§Ø³",
"Ø§Ù„Ù…Ù†Ø§Ø® Ø£ÙØ±ÙŠÙ‚ÙŠØ§","Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø£ÙØ±ÙŠÙ‚ÙŠØ§","Ø§Ù„Ø²Ø±Ø§Ø¹Ø© Ø£ÙØ±ÙŠÙ‚ÙŠØ§",
"Ø§Ù„Ø§Ø³ØªØ¹Ù…Ø§Ø± Ø£ÙØ±ÙŠÙ‚ÙŠØ§","Ù…Ø§Ù†Ø¯ÙŠÙ„Ø§","Ø§Ù„Ø§Ù†Ù‚Ù„Ø§Ø¨Ø§Øª Ø£ÙØ±ÙŠÙ‚ÙŠØ§",
"Ø§Ù„Ù„Ø§Ø¬Ø¦ÙˆÙ† Ø§Ù„Ø£ÙØ§Ø±Ù‚Ø©","Ø§Ù„Ù…Ø±Ø£Ø© Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠØ©","Ø§Ù„Ø´Ø¨Ø§Ø¨ Ø§Ù„Ø£ÙØ±ÙŠÙ‚ÙŠ"
]
};

function makeBook(id,title,authors,publisher,pubDate,pages,isbn,url,cover,desc,lang,source){
  return{id,title,authors:authors||[],publisher:publisher||'',publication_date:pubDate||'',
    pages:pages||null,isbn:isbn||'',book_url:url||'',cover:(cover||'').replace('http:','https:'),
    description:(desc||'').substring(0,500),language:lang||'en',
    topics:detectTopics(title,desc),source,rating:null,addedAt:Date.now()};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 1. Google Books API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcGoogleBooks(query,langR){
  const books=[];
  try{
    const p=new URLSearchParams({q:query,printType:'books',orderBy:'newest',maxResults:'40'});
    if(langR==='ar'||langR==='fr')p.set('langRestrict',langR);
    const r=await fetch('https://www.googleapis.com/books/v1/volumes?'+p);
    if(!r.ok)return books;
    const d=await r.json();
    for(const item of(d.items||[])){
      try{
        const v=item.volumeInfo||{};
        if(!v.title||!v.publishedDate)continue;
        if(!isWithin12Months(v.publishedDate))continue;
        const fullTitle=v.title+(v.subtitle?': '+v.subtitle:'');
        if(!isAfricaBook(fullTitle,v.description,v.authors))continue;
        const lang=v.language==='ar'?'ar':v.language==='fr'?'fr':detectLang(v.title);
        const isbns=v.industryIdentifiers||[];
        books.push(makeBook(item.id,fullTitle,v.authors,v.publisher,v.publishedDate,
          v.pageCount,(isbns.find(i=>i.type==='ISBN_13')||isbns[0]||{}).identifier,
          v.infoLink,(v.imageLinks||{}).thumbnail,v.description,lang,'Google Books'));
      }catch(e){}
    }
  }catch(e){}
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 2. Open Library API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcOpenLibrary(query){
  const books=[];
  try{
    const r=await fetch('https://openlibrary.org/search.json?q='+encodeURIComponent(query)+'&limit=30&sort=new');
    if(!r.ok)return books;
    const d=await r.json();
    for(const doc of(d.docs||[])){
      try{
        if(!doc.title)continue;
        const yr=doc.first_publish_year;if(!yr)continue;
        const pd=yr+'-01-01';if(!isWithin12Months(pd))continue;
        const subj=(doc.subject||[]).join(' ');
        if(!isAfricaBook(doc.title,subj,doc.author_name))continue;
        const cid=doc.cover_i;
        books.push(makeBook('ol_'+doc.key,doc.title,doc.author_name,(doc.publisher||[])[0],pd,
          doc.number_of_pages_median,(doc.isbn||[])[0],'https://openlibrary.org'+doc.key,
          cid?'https://covers.openlibrary.org/b/id/'+cid+'-M.jpg':'','',
          detectLang(doc.title),'Open Library'));
      }catch(e){}
    }
  }catch(e){}
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3. Crossref API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcCrossref(query){
  const books=[];
  try{
    const p=new URLSearchParams({query,filter:'type:book,from-pub-date:'+getMinDateStr(),rows:'20',sort:'published',order:'desc'});
    const r=await fetch('https://api.crossref.org/works?'+p,{headers:{'User-Agent':'AfricaBooks/1.0'}});
    if(!r.ok)return books;
    const d=await r.json();
    for(const item of((d.message||{}).items||[])){
      try{
        const title=(item.title||[])[0];if(!title)continue;
        const auths=(item.author||[]).map(a=>(a.given||'')+' '+(a.family||''));
        if(!isAfricaBook(title,(item.subject||[]).join(' '),auths))continue;
        const dp=(item['published-print']||item['published-online']||{})['date-parts'];
        if(!dp||!dp[0])continue;
        const pd=dp[0][0]+'-'+String(dp[0][1]||1).padStart(2,'0')+'-'+String(dp[0][2]||1).padStart(2,'0');
        if(!isWithin12Months(pd))continue;
        books.push(makeBook('cr_'+(item.DOI||Math.random().toString(36).substr(2,8)),title,auths.map(a=>a.trim()),
          item.publisher,pd,null,(item.ISBN||[])[0],item.URL||(item.DOI?'https://doi.org/'+item.DOI:''),
          '','',detectLang(title),'Crossref'));
      }catch(e){}
    }
  }catch(e){}
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4. OpenAlex API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcOpenAlex(query){
  const books=[];
  try{
    const minD=getMinDateStr();
    const p=new URLSearchParams({search:query,filter:'type:book,from_publication_date:'+minD,per_page:'30',sort:'publication_date:desc'});
    const r=await fetch('https://api.openalex.org/works?'+p,{headers:{'User-Agent':'mailto:r@example.com'}});
    if(!r.ok)return books;
    const d=await r.json();
    for(const w of(d.results||[])){
      try{
        const title=w.title||w.display_name;if(!title)continue;
        const pd=w.publication_date;if(!pd||!isWithin12Months(pd))continue;
        const auths=(w.authorships||[]).map(a=>(a.author||{}).display_name||'').filter(Boolean);
        const concepts=(w.concepts||[]).map(c=>c.display_name||'').join(' ');
        if(!isAfricaBook(title,concepts,auths))continue;
        const url=w.doi?'https://doi.org/'+w.doi.replace('https://doi.org/',''):(w.primary_location||{}).landing_page_url||'';
        books.push(makeBook('oa_'+w.id,title,auths,
          ((w.primary_location||{}).source||{}).display_name||'',
          pd,null,'',url,'','',detectLang(title),'OpenAlex'));
      }catch(e){}
    }
  }catch(e){}
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 5. Semantic Scholar API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcSemanticScholar(query){
  const books=[];
  try{
    const yr=new Date().getFullYear();
    const p=new URLSearchParams({query,limit:'20',fields:'title,authors,year,externalIds,url,publicationDate,venue,abstract',year:(yr-1)+'-'+yr});
    const r=await fetch('https://api.semanticscholar.org/graph/v1/paper/search?'+p);
    if(!r.ok)return books;
    const d=await r.json();
    for(const paper of(d.data||[])){
      try{
        if(!paper.title)continue;
        const pd=paper.publicationDate||paper.year+'-01-01';
        if(!isWithin12Months(pd))continue;
        const auths=(paper.authors||[]).map(a=>a.name||'');
        if(!isAfricaBook(paper.title,paper.abstract||paper.venue||'',auths))continue;
        const doi=(paper.externalIds||{}).DOI;
        books.push(makeBook('ss_'+paper.paperId,paper.title,auths,paper.venue||'',pd,null,
          '',doi?'https://doi.org/'+doi:paper.url||'','',paper.abstract||'',
          detectLang(paper.title),'Semantic Scholar'));
      }catch(e){}
    }
  }catch(e){}
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 6. DOAB (Directory of Open Access Books)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcDOAB(query){
  const books=[];
  try{
    const r=await fetch('https://directory.doabooks.org/rest/search?query='+encodeURIComponent(query)+'&expand=metadata',{
      headers:{Accept:'application/json'}});
    if(!r.ok)return books;
    const d=await r.json();
    const items=Array.isArray(d)?d:(d.items||d.results||[]);
    for(const item of items.slice(0,20)){
      try{
        const meta=item.metadata||item.expand&&item.expand.metadata||[];
        let title='',auths=[],pub='',pd='',desc='',isbn='',url='';
        if(Array.isArray(meta)){
          for(const m of meta){
            if(m.key==='dc.title')title=m.value;
            if(m.key==='dc.contributor.author')auths.push(m.value);
            if(m.key==='dc.publisher')pub=m.value;
            if(m.key==='dc.date.issued'||m.key==='dc.date.accessioned')pd=pd||m.value;
            if(m.key==='dc.description.abstract')desc=m.value;
            if(m.key==='dc.identifier.isbn')isbn=isbn||m.value;
            if(m.key==='dc.identifier.uri')url=url||m.value;
          }
        }else{
          title=item.name||item.title||'';
        }
        if(!title)continue;
        if(pd&&!isWithin12Months(pd))continue;
        if(!isAfricaBook(title,desc,auths))continue;
        books.push(makeBook('doab_'+(item.uuid||item.id||Math.random().toString(36).substr(2,8)),
          title,auths,pub,pd,null,isbn,url||'','',desc,detectLang(title),'DOAB'));
      }catch(e){}
    }
  }catch(e){}
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 7. OAPEN Library
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcOAPEN(query){
  const books=[];
  try{
    const r=await fetch('https://library.oapen.org/rest/search?query='+encodeURIComponent(query)+'&expand=metadata',{
      headers:{Accept:'application/json'}});
    if(!r.ok)return books;
    const d=await r.json();
    const items=Array.isArray(d)?d:(d.items||d.results||[]);
    for(const item of items.slice(0,20)){
      try{
        const meta=item.metadata||[];
        let title='',auths=[],pub='',pd='',desc='',isbn='',url='';
        if(Array.isArray(meta)){
          for(const m of meta){
            if(m.key==='dc.title')title=m.value;
            if(m.key==='dc.contributor.author')auths.push(m.value);
            if(m.key==='dc.publisher')pub=m.value;
            if(m.key==='dc.date.issued')pd=pd||m.value;
            if(m.key==='dc.description.abstract')desc=m.value;
            if(m.key==='dc.identifier.isbn')isbn=isbn||m.value;
            if(m.key==='dc.identifier.uri')url=url||m.value;
          }
        }else{
          title=item.name||item.title||'';
        }
        if(!title)continue;
        if(pd&&!isWithin12Months(pd))continue;
        if(!isAfricaBook(title,desc,auths))continue;
        books.push(makeBook('oapen_'+(item.uuid||Math.random().toString(36).substr(2,8)),
          title,auths,pub,pd,null,isbn,url,'',desc,detectLang(title),'OAPEN'));
      }catch(e){}
    }
  }catch(e){}
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 8. Internet Archive
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcInternetArchive(query){
  const books=[];
  try{
    const yr=new Date().getFullYear();
    const url='https://archive.org/advancedsearch.php?q='+encodeURIComponent(query)+'+mediatype:texts+year:['+
      (yr-1)+' TO '+yr+']&fl[]=identifier&fl[]=title&fl[]=creator&fl[]=publisher&fl[]=date&fl[]=year&fl[]=description&fl[]=isbn&rows=20&output=json';
    const r=await fetch(url);
    if(!r.ok)return books;
    const d=await r.json();
    for(const doc of((d.response||{}).docs||[])){
      try{
        if(!doc.title)continue;
        const pd=doc.date||doc.year+'-01-01';
        if(!isWithin12Months(pd))continue;
        const auths=doc.creator?[].concat(doc.creator):[];
        if(!isAfricaBook(doc.title,doc.description||'',auths))continue;
        books.push(makeBook('ia_'+doc.identifier,doc.title,auths,
          Array.isArray(doc.publisher)?doc.publisher[0]:doc.publisher||'',
          pd,null,Array.isArray(doc.isbn)?doc.isbn[0]:doc.isbn||'',
          'https://archive.org/details/'+doc.identifier,
          'https://archive.org/services/img/'+doc.identifier,
          doc.description||'',detectLang(doc.title),'Internet Archive'));
      }catch(e){}
    }
  }catch(e){}
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 9. Library of Congress (LOC)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcLOC(query){
  const books=[];
  try{
    const r=await fetch('https://www.loc.gov/books/?q='+encodeURIComponent(query)+'&fo=json&c=20&sp=1');
    if(!r.ok)return books;
    const d=await r.json();
    for(const item of(d.results||[])){
      try{
        const title=item.title||item.item&&item.item.title;if(!title)continue;
        const dateStr=(item.date||item.dates||[])[0]||'';
        const yr=dateStr?parseInt(dateStr):0;
        const pd=yr?yr+'-01-01':'';
        if(pd&&!isWithin12Months(pd))continue;
        const auths=(item.contributor||item.creators||[]).map(c=>typeof c==='string'?c:c.title||'');
        if(!isAfricaBook(title,item.description?item.description.join(' '):'',auths))continue;
        books.push(makeBook('loc_'+(item.id||Math.random().toString(36).substr(2,8)),
          title,auths,'',pd,null,'',item.url||item.id||'',
          item.image_url?item.image_url[0]||'':'','',detectLang(title),'Library of Congress'));
      }catch(e){}
    }
  }catch(e){}
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 10. BnF (BibliothÃ¨que nationale de France) via SRU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcBnF(query){
  const books=[];
  try{
    const sru='https://catalogue.bnf.fr/api/SRU?version=1.2&operation=searchRetrieve&query=bib.anywhere%3D%22'+
      encodeURIComponent(query)+'%22&recordSchema=dublincore&maximumRecords=15';
    const r=await fetch(sru);
    if(!r.ok)return books;
    const txt=await r.text();
    const parser=new DOMParser();
    const xml=parser.parseFromString(txt,'text/xml');
    const records=xml.querySelectorAll('record');
    records.forEach(rec=>{
      try{
        const rd=rec.querySelector('recordData');if(!rd)return;
        const getEl=(tag)=>{const el=rd.querySelector(tag)||rd.querySelector('dc\\:'+tag);return el?el.textContent:''};
        const title=getEl('title');if(!title)continue;
        const pd=getEl('date')||'';
        if(pd&&!isWithin12Months(pd.length===4?pd+'-01-01':pd))return;
        const auth=getEl('creator');
        if(!isAfricaBook(title,getEl('subject')+' '+getEl('description'),[auth]))return;
        books.push(makeBook('bnf_'+Math.random().toString(36).substr(2,8),
          title,auth?[auth]:[],getEl('publisher'),pd.length===4?pd+'-01-01':pd,null,
          '','https://catalogue.bnf.fr','',getEl('description'),
          detectLang(title),'BnF'));
      }catch(e){}
    });
  }catch(e){}
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 11. ISIDORE (French academic)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcISIDORE(query){
  const books=[];
  try{
    const r=await fetch('https://api.isidore.science/resource/search?q='+encodeURIComponent(query)+'&type=book&output=json&rows=15');
    if(!r.ok)return books;
    const d=await r.json();
    const items=(d.response||d.reply||{}).content||(d.response||{}).replies||[];
    const replies=Array.isArray(items)?items:items.reply?[].concat(items.reply):[];
    for(const item of replies.slice(0,15)){
      try{
        const title=item.title||item.isidore_title||'';if(!title)continue;
        const pd=item.date||item.isidore_date||'';
        if(pd&&!isWithin12Months(pd.length===4?pd+'-01-01':pd))continue;
        const auths=item.creator||item.isidore_creator;
        const authArr=auths?[].concat(auths):[];
        if(!isAfricaBook(title,item.description||item.subject||'',authArr))continue;
        books.push(makeBook('isid_'+Math.random().toString(36).substr(2,8),
          title,authArr,item.publisher||'',pd.length===4?pd+'-01-01':pd,null,
          '',item.url||item.uri||'','',item.description||'',
          detectLang(title),'ISIDORE'));
      }catch(e){}
    }
  }catch(e){}
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 12. BASE (Bielefeld Academic Search Engine)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcBASE(query){
  const books=[];
  try{
    const r=await fetch('https://api.base-search.net/cgi-bin/BaseHttpSearchInterface.fcgi?func=PerformSearch&query='+
      encodeURIComponent(query)+'+doctype:book&format=json&hits=15');
    if(!r.ok)return books;
    const d=await r.json();
    for(const doc of((d.response||{}).docs||[])){
      try{
        const title=doc.dctitle||doc.dcTitle;if(!title)continue;
        const pd=doc.dcdate||doc.dcyear||'';
        if(pd&&!isWithin12Months(pd.length===4?pd+'-01-01':pd))continue;
        const auths=doc.dccreator||doc.dcCreator||[];
        const authArr=Array.isArray(auths)?auths:[auths];
        if(!isAfricaBook(title,(doc.dcdescription||'')+(doc.dcsubject||''),authArr))continue;
        books.push(makeBook('base_'+Math.random().toString(36).substr(2,8),
          title,authArr.filter(Boolean),doc.dcpublisher||'',
          pd.length===4?pd+'-01-01':pd,null,'',doc.dclink||doc.dcidentifier||'',
          '','',detectLang(title),'BASE'));
      }catch(e){}
    }
  }catch(e){}
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 13. CORE API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcCORE(query){
  const books=[];
  try{
    const r=await fetch('https://api.core.ac.uk/v3/search/works?q='+encodeURIComponent(query)+
      '&limit=15&entity_type=book',{headers:{'Authorization':'Bearer free'}});
    if(!r.ok)return books;
    const d=await r.json();
    for(const item of(d.results||[])){
      try{
        const title=item.title;if(!title)continue;
        const pd=item.publishedDate||item.yearPublished+'-01-01'||'';
        if(pd&&!isWithin12Months(pd))continue;
        const auths=(item.authors||[]).map(a=>a.name||'');
        if(!isAfricaBook(title,item.abstract||'',auths))continue;
        books.push(makeBook('core_'+(item.id||Math.random().toString(36).substr(2,8)),
          title,auths,item.publisher||'',pd,null,'',
          item.downloadUrl||item.sourceFulltextUrls&&item.sourceFulltextUrls[0]||'',
          '','',detectLang(title),'CORE'));
      }catch(e){}
    }
  }catch(e){}
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 14. Europeana
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcEuropeana(query){
  const books=[];
  try{
    const yr=new Date().getFullYear();
    const r=await fetch('https://api.europeana.eu/record/v2/search.json?wskey=api2demo&query='+
      encodeURIComponent(query)+'&qf=TYPE:TEXT&rows=15&reusability=open');
    if(!r.ok)return books;
    const d=await r.json();
    for(const item of(d.items||[])){
      try{
        const title=(item.title||[])[0]||item.dcTitleLangAware&&Object.values(item.dcTitleLangAware)[0]&&Object.values(item.dcTitleLangAware)[0][0];
        if(!title)continue;
        const yr2=(item.year||[])[0];
        const pd=yr2?yr2+'-01-01':'';
        if(pd&&!isWithin12Months(pd))continue;
        const auths=(item.dcCreator||[]).concat(item.dcCreatorLangAware?Object.values(item.dcCreatorLangAware).flat():[]);
        if(!isAfricaBook(title,(item.dcDescription||[]).join(' '),auths))continue;
        books.push(makeBook('eu_'+(item.id||Math.random().toString(36).substr(2,8)),
          title,auths.filter(Boolean).slice(0,3),(item.dataProvider||[])[0]||'',pd,null,'',
          item.guid||item.link||'',
          item.edmPreview?item.edmPreview[0]:'','',
          detectLang(title),'Europeana'));
      }catch(e){}
    }
  }catch(e){}
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 15. WorldCat Search
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcWorldCat(query){
  const books=[];
  try{
    const r=await fetch('https://www.worldcat.org/webservices/catalog/search/opensearch?q='+
      encodeURIComponent(query)+'&format=json&count=15');
    if(!r.ok){
      const r2=await fetch('https://search.worldcat.org/api/search?q='+encodeURIComponent(query)+'&itemType=book&limit=15',
        {headers:{Accept:'application/json'}});
      if(!r2.ok)return books;
      const d2=await r2.json();
      for(const item of(d2.briefRecords||d2.entries||[]).slice(0,15)){
        try{
          const title=item.title;if(!title)continue;
          const pd=item.date||item.machineReadableDate||'';
          if(pd&&!isWithin12Months(pd.length===4?pd+'-01-01':pd))continue;
          const auths=item.creator||item.contributors||[];
          if(!isAfricaBook(title,item.summary||'',Array.isArray(auths)?auths:[auths]))continue;
          books.push(makeBook('wc_'+(item.oclcNumber||Math.random().toString(36).substr(2,8)),
            title,Array.isArray(auths)?auths:[auths],item.publisher||'',
            pd.length===4?pd+'-01-01':pd,null,item.isbn||'',
            'https://search.worldcat.org/title/'+item.oclcNumber,'','',
            detectLang(title),'WorldCat'));
        }catch(e){}
      }
      return books;
    }
    const d=await r.json();
    for(const item of(d.entries||d.items||[]).slice(0,15)){
      try{
        const title=item.title||item.content;if(!title)continue;
        if(!isAfricaBook(title,item.summary||'',item.author?[item.author]:[]))continue;
        books.push(makeBook('wc_'+Math.random().toString(36).substr(2,8),
          title,item.author?[item.author]:[],item.publisher||'','',null,'',
          item.link||item.id||'','','',detectLang(title),'WorldCat'));
      }catch(e){}
    }
  }catch(e){}
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 16. Google Scholar (via Serpapi proxy workaround - simplified)
// using alternative: DBLP for CS-related African tech books
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function srcDBLP(query){
  const books=[];
  try{
    const r=await fetch('https://dblp.org/search/publ/api?q='+encodeURIComponent(query)+'+africa&format=json&h=10&type=Books');
    if(!r.ok)return books;
    const d=await r.json();
    const hits=(d.result||{}).hits||{};
    for(const hit of(hits.hit||[])){
      try{
        const info=hit.info||{};
        const title=info.title;if(!title)continue;
        const yr=info.year;if(!yr)continue;
        const pd=yr+'-01-01';
        if(!isWithin12Months(pd))continue;
        const auths=info.authors&&info.authors.author?[].concat(info.authors.author).map(a=>typeof a==='string'?a:a.text||a['#text']||''):[];
        if(!isAfricaBook(title,'',auths))continue;
        books.push(makeBook('dblp_'+Math.random().toString(36).substr(2,8),
          title,auths,info.venue||'',pd,null,'',info.ee||info.url||'',
          '','',detectLang(title),'DBLP'));
      }catch(e){}
    }
  }catch(e){}
  return books;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchAllBooks(){
  if(isUpdating)return;
  isUpdating=true;
  activeSources.clear();
  const prevCount=ALL_BOOKS.length;
  document.getElementById('pbar').style.display='block';
  document.getElementById('rBtn').disabled=true;
  if(ALL_BOOKS.length===0)document.getElementById('grid').innerHTML='<div class="loader"><div class="spinner"></div><p>Ø¬Ø§Ø± Ø¬Ù„Ø¨ Ø§Ù„ÙƒØªØ¨ Ù…Ù† 16 Ù…ØµØ¯Ø±Ø§Ù‹...</p></div>';

  const newBooks=[];
  const tasks=[];

  // Google Books - 3 languages
  for(const q of Q.en)tasks.push({fn:()=>srcGoogleBooks(q,'en'),name:'Google Books',q,lang:'en'});
  for(const q of Q.fr)tasks.push({fn:()=>srcGoogleBooks(q,'fr'),name:'Google Books',q,lang:'fr'});
  for(const q of Q.ar)tasks.push({fn:()=>srcGoogleBooks(q,'ar'),name:'Google Books',q,lang:'ar'});
  // Open Library
  for(const q of Q.en.slice(0,20))tasks.push({fn:()=>srcOpenLibrary(q),name:'Open Library',q,lang:'en'});
  for(const q of Q.fr.slice(0,15))tasks.push({fn:()=>srcOpenLibrary(q),name:'Open Library',q,lang:'fr'});
  for(const q of Q.ar.slice(0,10))tasks.push({fn:()=>srcOpenLibrary(q),name:'Open Library',q,lang:'ar'});
  // Crossref
  for(const q of Q.en.slice(0,15))tasks.push({fn:()=>srcCrossref(q),name:'Crossref',q,lang:'en'});
  for(const q of Q.fr.slice(0,10))tasks.push({fn:()=>srcCrossref(q),name:'Crossref',q,lang:'fr'});
  // OpenAlex
  for(const q of Q.en.slice(0,15))tasks.push({fn:()=>srcOpenAlex(q),name:'OpenAlex',q,lang:'en'});
  for(const q of Q.fr.slice(0,10))tasks.push({fn:()=>srcOpenAlex(q),name:'OpenAlex',q,lang:'fr'});
  // Semantic Scholar
  for(const q of Q.en.slice(0,12))tasks.push({fn:()=>srcSemanticScholar(q),name:'Semantic Scholar',q,lang:'en'});
  // DOAB
  for(const q of Q.en.slice(0,8))tasks.push({fn:()=>srcDOAB(q),name:'DOAB',q,lang:'en'});
  for(const q of Q.fr.slice(0,6))tasks.push({fn:()=>srcDOAB(q),name:'DOAB',q,lang:'fr'});
  // OAPEN
  for(const q of Q.en.slice(0,8))tasks.push({fn:()=>srcOAPEN(q),name:'OAPEN',q,lang:'en'});
  for(const q of Q.fr.slice(0,6))tasks.push({fn:()=>srcOAPEN(q),name:'OAPEN',q,lang:'fr'});
  // Internet Archive
  for(const q of Q.en.slice(0,10))tasks.push({fn:()=>srcInternetArchive(q),name:'Internet Archive',q,lang:'en'});
  for(const q of Q.fr.slice(0,6))tasks.push({fn:()=>srcInternetArchive(q),name:'Internet Archive',q,lang:'fr'});
  // LOC
  for(const q of Q.en.slice(0,8))tasks.push({fn:()=>srcLOC(q),name:'LOC',q,lang:'en'});
  // BnF
  for(const q of Q.fr.slice(0,10))tasks.push({fn:()=>srcBnF(q),name:'BnF',q,lang:'fr'});
  // ISIDORE
  for(const q of Q.fr.slice(0,8))tasks.push({fn:()=>srcISIDORE(q),name:'ISIDORE',q,lang:'fr'});
  // BASE
  for(const q of Q.en.slice(0,8))tasks.push({fn:()=>srcBASE(q),name:'BASE',q,lang:'en'});
  for(const q of Q.fr.slice(0,5))tasks.push({fn:()=>srcBASE(q),name:'BASE',q,lang:'fr'});
  // CORE
  for(const q of Q.en.slice(0,8))tasks.push({fn:()=>srcCORE(q),name:'CORE',q,lang:'en'});
  // Europeana
  for(const q of Q.en.slice(0,6))tasks.push({fn:()=>srcEuropeana(q),name:'Europeana',q,lang:'en'});
  for(const q of Q.fr.slice(0,5))tasks.push({fn:()=>srcEuropeana(q),name:'Europeana',q,lang:'fr'});
  // WorldCat
  for(const q of Q.en.slice(0,6))tasks.push({fn:()=>srcWorldCat(q),name:'WorldCat',q,lang:'en'});
  for(const q of Q.fr.slice(0,4))tasks.push({fn:()=>srcWorldCat(q),name:'WorldCat',q,lang:'fr'});
  // DBLP
  for(const q of Q.en.slice(0,4))tasks.push({fn:()=>srcDBLP(q),name:'DBLP',q,lang:'en'});

  const total=tasks.length;
  let done=0;

  // Process in batches of 3 concurrent
  for(let i=0;i<tasks.length;i+=3){
    const batch=tasks.slice(i,i+3);
    const results=await Promise.allSettled(batch.map(async t=>{
      try{
        const res=await t.fn();
        if(res.length>0){
          activeSources.set(t.name,(activeSources.get(t.name)||0)+res.length);
          newBooks.push(...res);
        }
        return res;
      }catch(e){return[]}
    }));
    done+=batch.length;
    const pct=Math.round((done/total)*100);
    document.getElementById('pfill').style.width=pct+'%';
    const currentTask=batch[batch.length-1];
    document.getElementById('ptxt').textContent=pct+'% | '+currentTask.name+' ['+currentTask.lang+'] '+currentTask.q.substring(0,25)+'...';
    
    // Live update
    if(newBooks.length>0&&done%12===0){
      const temp=dedup([...ALL_BOOKS,...newBooks]);
      temp.sort((a,b)=>new Date(b.publication_date)-new Date(a.publication_date));
      ALL_BOOKS=temp;
      updateStats();filterBooks();updateSourcesUI();
    }
    await sleep(300);
  }

  ALL_BOOKS=dedup([...ALL_BOOKS,...newBooks]);
  ALL_BOOKS.sort((a,b)=>new Date(b.publication_date)-new Date(a.publication_date));
  const addedCount=ALL_BOOKS.length-prevCount;

  try{localStorage.setItem(CACHE_KEY,JSON.stringify({books:ALL_BOOKS,timestamp:Date.now(),sources:Object.fromEntries(activeSources)}))}catch(e){}

  document.getElementById('pbar').style.display='none';
  document.getElementById('rBtn').disabled=false;
  isUpdating=false;
  updateStats();filterBooks();updateTime();updateSourcesUI();updateSourceFilter();
  if(addedCount>0&&prevCount>0)showNotif('ØªÙ… Ø¥Ø¶Ø§ÙØ© '+addedCount+' ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† '+activeSources.size+' Ù…ØµØ¯Ø±!');
}

function updateSourcesUI(){
  const allSources=['Google Books','Open Library','Crossref','OpenAlex','Semantic Scholar',
    'DOAB','OAPEN','Internet Archive','LOC','BnF','ISIDORE','BASE','CORE','Europeana','WorldCat','DBLP'];
  const html=allSources.map(s=>{
    const count=activeSources.get(s)||0;
    const on=count>0;
    return '<span class="src-tag"><span class="dot '+(on?'on':'off')+'"></span>'+s+(on?' ('+count+')':'')+'</span>';
  }).join('');
  document.getElementById('srcStats').innerHTML='<div class="src-grid">'+html+'</div>';
}

function updateSourceFilter(){
  const sel=document.getElementById('srcSel');
  const current=sel.value;
  const sources=new Set(ALL_BOOKS.map(b=>b.source));
  sel.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ø± ('+sources.size+')</option>';
  [...sources].sort().forEach(s=>{
    const count=ALL_BOOKS.filter(b=>b.source===s).length;
    sel.innerHTML+='<option value="'+esc(s)+'">'+esc(s)+' ('+count+')</option>';
  });
  sel.value=current;
}

// â•â•â•â•â•â•â•â•â•â• Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ â•â•â•â•â•â•â•â•â•â•
function setLang(lang,btn){
  currentLang=lang;
  document.querySelectorAll('.fbtn').forEach(b=>b.className='fbtn');
  if(lang==='all')btn.classList.add('active');else btn.classList.add('a-'+lang);
  filterBooks();
}

function filterBooks(){
  const search=document.getElementById('searchInput').value.toLowerCase();
  const topic=document.getElementById('topicSel').value;
  const src=document.getElementById('srcSel').value;
  const sort=document.getElementById('sortSel').value;

  let list=ALL_BOOKS.filter(b=>{
    if(currentLang!=='all'&&b.language!==currentLang)return false;
    if(topic&&!b.topics.some(t=>t.toLowerCase().includes(topic.toLowerCase())))return false;
    if(src&&b.source!==src)return false;
    if(search){
      const hay=(b.title+' '+b.authors.join(' ')+' '+b.publisher+' '+(b.description||'')).toLowerCase();
      if(!hay.includes(search))return false;
    }
    return true;
  });

  switch(sort){
    case'newest':list.sort((a,b)=>new Date(b.publication_date)-new Date(a.publication_date));break;
    case'oldest':list.sort((a,b)=>new Date(a.publication_date)-new Date(b.publication_date));break;
    case'rating':list.sort((a,b)=>(b.rating||0)-(a.rating||0));break;
    case'title':list.sort((a,b)=>a.title.localeCompare(b.title,'ar'));break;
  }
  renderBooks(list);
}

function renderBooks(books){
  const grid=document.getElementById('grid');
  if(!books.length&&ALL_BOOKS.length===0){
    grid.innerHTML='<div class="loader"><div class="spinner"></div><p>Ø¬Ø§Ø± Ø¬Ù„Ø¨ Ø§Ù„ÙƒØªØ¨...</p></div>';return;
  }
  if(!books.length){
    grid.innerHTML='<div class="no-res"><div class="emoji">ğŸŒ</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ù…Ø·Ø§Ø¨Ù‚Ø©</p></div>';return;
  }
  const hot=['Conflict','Terrorism','Sahel','Security','Coups','Refugees','Migration'];
  grid.innerHTML=books.map(b=>{
    const lc='l-'+b.language;
    const ll=b.language==='ar'?'Ø¹Ø±Ø¨ÙŠ':b.language==='fr'?'FranÃ§ais':'English';
    const date=fmtDate(b.publication_date);
    const coverHTML=b.cover
      ?'<img src="'+b.cover+'" alt="" loading="lazy" onerror="this.onerror=null;this.parentElement.innerHTML=\'<div style=\\\'width:130px;height:180px;background:linear-gradient(135deg,#1B5E20,#D4A017);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:4em;position:relative;z-index:2\\\'>ğŸŒ</div>\'\">'
      :'<div style="width:130px;height:180px;background:linear-gradient(135deg,#1B5E20,#D4A017);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:4em;position:relative;z-index:2">ğŸŒ</div>';
    const tags=b.topics.slice(0,4).map(t=>'<span class="tag '+(hot.some(h=>t.includes(h))?'hot':'')+'">'+esc(t)+'</span>').join('');
    return'<div class="book-card"><div class="cover-wrap">'+coverHTML+
      '<span class="lang-badge '+lc+'">'+ll+'</span><span class="src-badge">'+esc(b.source)+'</span></div>'+
      '<div class="book-body" dir="rtl"><div class="book-title">'+esc(b.title)+'</div>'+
      '<div class="book-author">'+esc(b.authors.slice(0,3).join(', ')||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')+'</div>'+
      '<div class="book-pub">'+esc(b.publisher||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')+'</div>'+
      '<div class="book-meta">'+(date?'<span>ğŸ“… '+date+'</span>':'')+
      (b.pages?'<span>ğŸ“„ '+b.pages+'</span>':'')+
      (b.rating?'<span>â­ '+b.rating.toFixed(1)+'</span>':'')+
      (b.isbn?'<span>ğŸ“‹ ISBN</span>':'')+'</div>'+
      '<div class="topics">'+tags+'</div>'+
      (b.description?'<div class="book-desc">'+esc(b.description)+'</div>':'')+
      '<div class="book-actions">'+
      (b.book_url?'<a href="'+esc(b.book_url)+'" target="_blank" class="blink bp">ğŸ”— Ø§Ù„ÙƒØªØ§Ø¨</a>':'')+
      (b.isbn?'<a href="https://www.worldcat.org/isbn/'+b.isbn+'" target="_blank" class="blink bs">ğŸ“š WorldCat</a>':'')+
      '</div></div></div>';
  }).join('');
}

function updateStats(){
  document.getElementById('sTotal').textContent=ALL_BOOKS.length;
  document.getElementById('sAr').textContent=ALL_BOOKS.filter(b=>b.language==='ar').length;
  document.getElementById('sEn').textContent=ALL_BOOKS.filter(b=>b.language==='en').length;
  document.getElementById('sFr').textContent=ALL_BOOKS.filter(b=>b.language==='fr').length;
  document.getElementById('sPub').textContent=new Set(ALL_BOOKS.map(b=>b.publisher).filter(Boolean)).size;
  document.getElementById('sSrc').textContent=activeSources.size;
}

function updateTime(){document.getElementById('lastUp').textContent='Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: '+fmtDateTime()}

function manualRefresh(){
  localStorage.removeItem(CACHE_KEY);ALL_BOOKS=[];fetchAllBooks();
}

// â•â•â•â•â•â•â•â•â•â• Ø§Ù„ØªØ´ØºÙŠÙ„ â•â•â•â•â•â•â•â•â•â•
(async function(){
  try{
    const raw=localStorage.getItem(CACHE_KEY);
    if(raw){
      const cache=JSON.parse(raw);
      if(cache&&cache.books&&cache.books.length>0){
        ALL_BOOKS=cache.books;
        if(cache.sources){
          if(cache.sources instanceof Object)Object.entries(cache.sources).forEach(([k,v])=>activeSources.set(k,v));
        }
        updateStats();filterBooks();updateTime();updateSourcesUI();updateSourceFilter();
        if(Date.now()-(cache.timestamp||0)<DAILY_MS){setTimeout(()=>fetchAllBooks(),DAILY_MS-(Date.now()-cache.timestamp));return}
      }
    }
  }catch(e){}
  await fetchAllBooks();
})();
setInterval(()=>fetchAllBooks(),DAILY_MS);
</script>
</body>
</html>
